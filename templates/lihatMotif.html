<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Modul Lidi</title>
    {% load static %}
    <link rel="icon" href="{% static 'img/icon/NewTitle.ico'%}" type="image/x-icon">
    <link rel="stylesheet" href="{% static 'templatemo-style.css'%}">
    <link rel="stylesheet" href="{% static 'style.css'%}">
    <link rel="stylesheet" href="{% static 'image.css'%}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

    <style>
        .motif-grid {
            display: block;
            image-rendering: pixelated !important;
            image-rendering: -moz-crisp-edges !important;
            image-rendering: crisp-edges !important;
            border: 1px solid #ddd;
            background-color: white;
            max-width: 100%;
            max-height: 400px;
            margin: 15px auto;
        }
        
        .motif-container {
            text-align: center;
            margin: 20px auto;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            max-width: 800px;
        }
        
        .debug-path {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            padding: 5px;
            background-color: #f8f9fa;
            border-radius: 3px;
            display: inline-block;
        }
        
        .error-placeholder {
            width: 100%;
            max-width: 600px;
            height: 200px;
            background-color: #f8f9fa;
            border: 1px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px auto;
            color: #666;
            font-size: 14px;
        }
        /* filepath: c:\Users\1652\Downloads\AutoGenerateMotif\AutoGenerateMotif\templates\lihatMotif.html */
        .centerline {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: red;
            transform: translateY(-50%);
            z-index: 1;
        }

        /* Grid overlay */
        .grid-overlay {
            position: relative;
        }

        .grid-overlay img {
            display: block;
            width: 100%;
            height: auto;
        }

        .grid-overlay::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: grid;
            grid-template-columns: repeat(40, 1fr); /* Finer grid */
            grid-template-rows: repeat(40, 1fr); /* Finer grid */
            z-index: 10; /* Ensures grid is above the image */
            background-image: linear-gradient(rgba(0, 0, 0, 0.3) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(0, 0, 0, 0.1) 1px, transparent 1px);
            background-size: 10px 10px; /* Increased grid cell size */
        }

        .text-muted {
            word-wrap: break-word;
            white-space: normal;
        }

        .text-center {
            word-wrap: break-word;
            white-space: normal;
        }

        #text_motif_asal, #text_motif_hasil {
            word-wrap: break-word;
            white-space: normal;
        }

        .image-container {
            position: relative; /* Ensures grid overlays the image */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            width: 100%;
            height: auto;
        }

        .image-container img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            display: block;
            object-fit: contain;
        }

        .container {
            max-width: 130%; /* Further increased max-width */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        #image-section {
            width: 110%; /* Further increased width */
            display: flex;
            flex-direction: column;
            gap: 0;
            align-items: center;
        }

        .row-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 15px; /* Increased gap for better spacing */
            margin: 0;
            padding: 0;
            line-height: 0;
        }

        .image-container {
            width: 95%; /* Further increased width */
            margin: 0;
            padding: 0;
            position: relative;
        }

        .image-container img {
            width: 100%;
            height: auto;
            object-fit: contain;
            margin: 0;
            padding: 0;
        }

        .grid-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            pointer-events: none;
            grid-template-columns: repeat(20, 1fr);
            grid-template-rows: repeat(20, 1fr);
        }

        .grid-lines div {
            border: 2px solid rgba(0, 0, 0, 0.1);
        }

        .lidi {
            text-align: center;
            margin: 0;
            padding: 0;
            font-size: 0.6rem;
            line-height: 0;
        }

        .lidi-motif-asal {
            text-align: center;
            margin: 0;
            padding: 0;
            font-size: 0.2rem;
            line-height: 0;
        }
    </style>
</head>
<body>

    <!-- Page Loader -->
    <div id="loader-wrapper">
        <div id="loader"></div>
        <div class="loader-section section-left"></div>
        <div class="loader-section section-right"></div>
    </div>

    {% include "header.html" %}
    
    {% if error_messages %}
    <div class="alert alert-danger">
        <ul>wai
            {% for message in error_messages %}
                <li>{{ message }}</li>
            {% endfor %}
        </ul>
        <a href="{% url 'regenerate_motif' motif.id %}" class="btn btn-primary">Regenerate Motif</a>
    </div>
    {% endif %}

    <!-- Tambahkan keterangan jika ini adalah motif gabungan -->
    {% if motif.jenisGenerate == "combine" %}
    <div class="alert alert-info">
        <p><strong>Info:</strong> Ini adalah motif gabungan. Urutan lidi dan grid telah dihasilkan otomatis berdasarkan tinggi motif.</p>
    </div>
    {% endif %}

    <h2 class="tm-text-primary text-center" style="margin-bottom: 0px;">Motif Asal</h2>
    <div class="container">
        <div id="image-section">
            {% for item1 in list_lidi_path %}
            <div class="row-container">
                <div class="image-container grid-overlay">
                    <img src="{{ item1 }}" onclick="openModal(this);">
                    <div class="grid-lines">
                        {% for i in 0|make_list %}
                        <div></div>
                        {% endfor %}
                    </div>
                </div>
                <div class="lidi-motif-asal">
                    Lidi {{ forloop.counter }}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="myModal" class="modal">
        <span class="close" onclick="closeModal();">&times;</span>
        <img class="modal-content" src="/{{GridHelp}}" style="border-radius: 0px;">
        <img class="modal-content" id="img01" style="border-radius: 0px;">
        <img class="modal-content" src="/{{GridHelp}}" style="border-radius: 0px;">
        <p class="modal-content1 text-center" style="position: absolute; color: black; font-size: 30px;">Helllo World</p>
    </div>

    <h2 class="tm-text-primary text-center mt-4" style="margin-bottom: -70px;">Hasil Motif</h2>
    <div class="container">
        <div id="image-section">
            {% for Motif1, Motif2 in slice %}
            <div class="row-container">
                <div class="image-container grid-overlay">
                    <img src="{{Motif1}}" data-nama-gambar="Lidi {{Motif2}}" onclick="openModal(this);">
                    <div class="grid-lines">
                        {% for i in 0|make_list %}
                        <div></div>
                        {% endfor %}
                    </div>
                </div>
                <div class="lidi">
                    Lidi {{Motif2}}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="container m-4" style="display: flex; flex-wrap; max-width: 100vw; align-items: baseline;">
        <div style="width: 100vw;">
            <p style="margin-top: 30px;">Keterangan</p>
        </div>
        <div style="width: 10vw">
            <div style="border: 5px solid rgba(255, 0, 0, 0.9)"></div> 
        </div>
        <div class="text-center" style="width: 5vw">
            <p>:</p>
        </div>
        <div style="width: 50vw;">
            <p>Garis merah merupakan garis bantu yang menunjukkan garis tengah pada motif</p>
        </div>
    </div>     
</div> 

    
    
    <div class="container-fluid tm-container-content tm-mt-60">
        <div class="row tm-mb-90">                     
            <div class="col-xl-8 col-lg-7 col-md-6 col-sm-12">
                <h2 class="tm-text-primary text-center">Motif Asal</h2>
                <div class="motif-container">
                    <!-- PERBAIKAN UTAMA: Periksa dan perbaiki path gambar -->
                    <img id="lidiImage" class="motif-grid" alt="Motif Asal">
                    <div class="debug-path" id="lidiPath">Path: {{ Lidi }}</div>
                    
                    <!-- Tampilkan urutan lidi -->
                    <div class="mt-2">
                        {% if UrutanLidi %}
                            <small class="text-muted">Urutal Lidi:                            
                                {% for item1 in list_lidi_path %}
                                {% if forloop.last %}
                                    {{ forloop.counter }}
                                {% else %}
                                    {{ forloop.counter }},
                                {% endif %}
                            {% endfor %}</small>
                        {% endif %}
                    </div>
                    
                    <!-- Fallback jika gambar tidak ada -->
                    <div id="lidiError" class="error-placeholder" style="display: none;">
                        <div>Gambar motif tidak dapat dimuat</div>
                    </div>
                </div>
                
                <h2 class="tm-text-primary text-center mt-4">Hasil Motif</h2>
                <div class="motif-container">
                    <!-- PERBAIKAN UTAMA: Periksa dan perbaiki path gambar -->
                    <img id="redLineImage" class="motif-grid" alt="Hasil Motif">
                    <div class="debug-path" id="redLinePath">Path: {{ RedLine }}</div>
                    <div class="mt-2">
                        <small class="text-muted" class="text-center">Urutan Lidi: {{motif.urutanLidi}}</small>
                    </div>
                    
                    <!-- Tampilkan garis tengah -->
                    <div class="mt-2">
                        <div style="display: inline-block; width: 50px; border-top: 2px solid red; vertical-align: middle;"></div>
                        <small class="text-muted ml-2" style="vertical-align: middle;"> : Garis tengah motif</small>
                    </div>
                    
                    <!-- Fallback jika gambar tidak ada -->
                    <div id="redLineError" class="error-placeholder" style="display: none;">
                        <div>Gambar motif tidak dapat dimuat</div>
                    </div>
                </div>
            </div> 
            <div class="col-xl-4 col-lg-5 col-md-6 col-sm-12">
                <div class="tm-bg-gray tm-video-details">
                    <div class="mb-4">
                        <h3 class="text-center tm-text-gray-dark mb-3" id="text_motif_asal">Urutan lidi motif asal</h3>
                        <p class="text-center">            
                            {% for item1 in list_lidi_path %}
                                {% if forloop.last %}
                                    {{ forloop.counter }}
                                {% else %}
                                    {{ forloop.counter }},
                                {% endif %}
                            {% endfor %}
                        </p>
                    </div>                    
                    <div class="mb-4">
                        <h3 class="text-center tm-text-gray-dark mb-3" id="text_motif_hasil">Urutan lidi hasil motif</h3>
                        <p class="text-center">{{motif.urutanLidi}}</p>
                    </div>
                    
                    <div class="mb-4 d-flex flex-wrap">
                        <div class="mr-4 mb-2">
                            <span class="tm-text-gray-dark">Nama Pembuat: </span>
                            <span><a class="link" href="{% url 'tagUser' motif.user %}">{{motif.user}}</a> </span>
                        </div>
                    </div>
                    <div class="mb-4 d-flex flex-wrap">
                        <div class="mr-4 mb-2">
                            <span class="tm-text-gray-dark">tanggal: </span><a class="link" href="{% url 'tagTime' motif.time %}">{{ motif.time|date:"d-m-Y" }}</a>
                        </div>
                    </div>
                    <div class="mb-4 d-flex flex-wrap">
                        <div class="mr-4 mb-2">
                            <span class="tm-text-gray-dark">Jumlah Baris: </span><a class="link" href="{% url 'tagJmlBaris' motif.jmlBaris %}">{{ motif.jmlBaris|length }} Baris</a></span>
                        </div>
                    </div>
                    <div class="mb-4 d-flex flex-wrap">
                        <div class="mr-4 mb-2">
                            <span class="tm-text-gray-dark">Format: </span><span class="tm-text-primary">PNG</span>
                        </div>
                    </div>
                    <div class="text-center mb-5">
                        <a href="{{ motif.imgAfter|default:'' }}" class="btn btn-outline-primary tm-btn-big mb-4" download style="margin-bottom: 10px; width: 100%;"> Unduh Motif </a>
                        <a href="{{ motif.imgBefore|default:'' }}" class="btn btn-outline-primary tm-btn-big mb-4" download style="margin-bottom: 10px; width: 100%;"> Unduh Lidi </a>
                        <div class="text-center">
                            <a href="{% url 'ubah_warna_combined' motif.id %}" class="btn btn-primary mt-3" style="background-color: #002BA3;">
                                Warnai Motif
                            </a>
                        </div>
                    </div>
                    {% if status %}
                    <form action="/delete/" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="text-center">
                            <div class="form-group" style="padding-top: 10px;"> 
                                <input type="hidden" class="form-control" name="DeleteImage" value="{{ motif.id}}" required>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-danger tm-btn-big" data-bs-toggle="modal" data-bs-target="#ModalDelete" style="width: 100%;">Hapus</button>
                        <div class="modal fade" id="ModalDelete" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog" style="top: 50%;">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLabel">Konfirmasi hapus</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        Apakah anda yakin mengambil tindakan untuk menghapus motif ini?
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-outline-primary tm-btn-big" style="width: 100%;" data-bs-dismiss="modal">Batal</button>
                                        <input type="submit" value="Hapus" id="DeleteForm">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="text-center" style="margin-top: 30px;">
            <a href="{% url 'list1' %}" style="background-color: #002BA3; border: 0px; border-radius: 5px; padding: 12px 50px 14px; font-size: 1.2rem; color: #fff; text-decoration: none;"> Kembali </a>
        </div>
    </div>
    
    {% if status1 %}
    {% else %}
    <div class="row d-flex justify-content-center">
        <div class="d-flex justify-content-center bd-highlight mb-3 example-parent" style="padding-top: 10%;">
            <div class="col-md-10 col">
                <h3 class="font-weight-bold ml-md-0 mx-auto text-center"> Akun Belum Diverifikasi oleh Admin </h3>
                <p class="mt-md-4 ml-md-0 ml-2 text-center"> Silahkan menghubungi admin terkait untuk dapat menggunakan fitur generate motif</p>
            </div>
        </div>
    </div>
    <br>
    {% endif %}
    
    {% include "footer.html" %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script src="{% static 'plugins.js'%}"></script>
    <script>
        $(window).on("load", function() {
            $('body').addClass('loaded');
            
            initializeImages();
        });
        
        function initializeImages() {
            var lidiPath = "{{ motif_asal }}";
            var redLinePath = "{{ RedLine }}";
            
            // Log untuk debugging
            console.log("Original Lidi Path:", lidiPath);
            console.log("Original RedLine Path:", redLinePath);
            
            tryImagePaths("lidiImage", lidiPath, "lidiError");
            
            tryImagePaths("redLineImage", redLinePath, "redLineError");
        }
        
        function tryImagePaths(imgId, originalPath, errorId) {
            var img = document.getElementById(imgId);
            var errorDiv = document.getElementById(errorId);
            
            // Daftar kemungkinan path untuk dicoba
            var pathVariations = [
                originalPath,
                "/" + originalPath,
                originalPath.replace(/^\//, ""), // Hapus slash di depan jika ada
                "/media" + originalPath,    // Coba dengan /media di depan
                "/media/" + originalPath.replace(/^\//, ""),
                "{% get_media_prefix %}" + originalPath.replace(/^\//, ""),
                "/static" + originalPath,
                "/static/" + originalPath.replace(/^\//, "") // Coba dengan /static/
            ];
            
            // Set variabel untuk menandai jika sudah berhasil
            var success = false;
            var currentPathIndex = 0;
            
            // Fungsi untuk mencoba path berikutnya
            function tryNextPath() {
                if (currentPathIndex >= pathVariations.length) {
                    // Semua path sudah dicoba, tampilkan error
                    console.error("Failed to load image after trying all path variations");
                    errorDiv.style.display = "flex";
                    img.style.display = "none";
                    return;
                }
                
                var currentPath = pathVariations[currentPathIndex];
                console.log("Trying path variation", currentPathIndex + 1, ":", currentPath);
                
                // Set path gambar
                img.src = currentPath;
                currentPathIndex++;
            }
            
            // Event handler untuk success
            img.onload = function() {
                console.log("Success loading image:", img.src);
                success = true;
                errorDiv.style.display = "none";
                img.style.display = "block";
                
                // Tambahkan kelas CSS agar grid terlihat
                img.classList.add("loaded");
            };
            
            // Event handler untuk error
            img.onerror = function() {
                console.error("Failed to load image with path:", img.src);
                // Coba path berikutnya
                tryNextPath();
            };
            
            // Mulai mencoba path pertama
            tryNextPath();
        }
        
        function openModal(img) {
            var modal = document.getElementById("myModal");
            var modalImg = document.getElementById("img01");
            var namaGambar = img.dataset.namaGambar;
            modal.style.display = "block";
            modalImg.src = img.src;
            var teksLama = document.querySelector("#myModal p");
            teksLama.textContent = namaGambar;
        }
        
        function closeModal() {
            var modal = document.getElementById("myModal");
            modal.style.display = "none";
        }

        // document.addEventListener("DOMContentLoaded", function () {
        //     const gridOverlays = document.querySelectorAll(".grid-overlay");

        //     gridOverlays.forEach(overlay => {
        //         const img = overlay.querySelector("img");
        //         const gridLines = overlay.querySelector(".grid-lines");

        //         img.onload = function () {
        //             const overlayWidth = img.offsetWidth; 
        //             const overlayHeight = img.offsetHeight; 
        //             const columns = Math.ceil(overlayWidth / 20);
        //             const rows = Math.ceil(overlayHeight / 20);

        //             gridLines.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
        //             gridLines.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

        //             // Add grid cells dynamically
        //             gridLines.innerHTML = "";
        //             for (let i = 0; i < columns * rows; i++) {
        //                 const cell = document.createElement("div");
        //                 cell.style.border = "1px solid rgba(0, 0, 0, 0.7)"; 
        //                 gridLines.appendChild(cell);
        //             }
        //         };
        //     });
        // });

        document.addEventListener("DOMContentLoaded", function () {
            const gridImages = [
                { imgId: "lidiImage", gridId: "lidiPath" },
                { imgId: "redLineImage", gridId: "redLinePath" }
            ];

            gridImages.forEach(({ imgId }) => {
                const img = document.getElementById(imgId);
                const container = img.parentElement;

                img.onload = function () {
                    const overlayWidth = img.naturalWidth; 
                    const overlayHeight = img.naturalHeight; 

                    // Create grid container dynamically
                    const gridOverlay = document.createElement("div");
                    gridOverlay.classList.add("grid-overlay");
                    gridOverlay.style.position = "absolute";
                    gridOverlay.style.top = "0";
                    gridOverlay.style.left = "0";
                    gridOverlay.style.width = `${overlayWidth}px`;
                    gridOverlay.style.height = `${overlayHeight}px`;
                    gridOverlay.style.pointerEvents = "none";
                    gridOverlay.style.display = "grid";

                    const columns = 20; 
                    const rows = 10; 

                    gridOverlay.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
                    gridOverlay.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

                    // Add grid cells dynamically
                    for (let i = 0; i < columns * rows; i++) {
                        const cell = document.createElement("div");
                        cell.style.border = "1px solid rgba(0, 0, 0, 0.7)";
                        gridOverlay.appendChild(cell);
                    }

                    const centerLine = document.createElement("div");
                    centerLine.style.position = "absolute";
                    centerLine.style.left = "0";
                    centerLine.style.width = "100%";
                    centerLine.style.height = "2px";
                    centerLine.style.backgroundColor = "red";
                    centerLine.style.transform = "translateY(-50%)";
                    gridOverlay.appendChild(centerLine);

                    container.style.position = "relative";
                    container.appendChild(gridOverlay);
                };
            });
        });
    </script>
</body>
</html>