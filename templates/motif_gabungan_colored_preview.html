<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}" />
    <link
      rel="icon"
      href="{% static 'img/icon/NewTitle.ico'%}"
      type="image/x-icon"
    />
    <link rel="stylesheet" href="{% static 'templatemo-style.css'%}" />
    <link rel="stylesheet" href="{% static 'image.css'%}" />

    <title>Pratinjau Gabungan Motif</title>

  <style>
      .image-container {
        width: 100vw;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .image-container img {
        width: 100%;
        height: auto;
        object-fit: contain;
        min-width: 1200px;
      }

      .container {
        display: flex;
        flex-direction: column;
        gap: 0;
        align-items: center;
        margin: 0 !important;
        padding: 0 !important;
      }

      .image-container div {
        text-align: center;
      }

      .lidi {
        text-align: center;
        margin: 5px 0 0 10px;
        padding: 5px 15px;
        font-size: 1.2rem;
        line-height: 1.2;
        font-weight: bold;
        color: #333;
        background-color: #f8f9fa;
        white-space: nowrap;
      }

      #download-buttons a {
        margin: 0 5px;
        padding: 12px 24px;
        font-size: 1.2rem;
        text-align: center;
        width: 250px;
        border-radius: 0px;
      }

      .title-text {
        font-size: 2rem;
        font-weight: bold;
        color: #002ba3;
        text-align: center;
        margin: 0 !important;
        padding: 0 !important;
        text-decoration: underline;
      }

      .info-text {
        text-align: justify;
        margin: 10px 20px !important;
        padding: 5px 0 !important;
        font-size: 1.5rem;
        font-weight: normal;
        color: #333;
      }

      #image-section {
        margin: 0 !important;
        padding: 0 !important;
      }

      #image-section p:first-child {
        margin-top: 0 !important;
      }

      .motif-row {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin: 0;
        padding: 0;
        width: 100%;
      }

      .lidi-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 150px;
      }

      .download-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        margin: 0;
        padding: 0;
      }

      #download-buttons {
        display: flex;
        flex-direction: row;
        gap: 10px;
        align-items: center;
        margin: 0;
        padding: 0;
      }

      #back-button {
        display: flex;
        justify-content: center;
        width: 100%;
        margin-top: 10px;
        padding: 0;
        border-radius: 0px;
      }

      #back-button a {
        background-color: transparent;
        border: 2px solid #002ba3;
        border-radius: 0px;
        padding: 12px 30px 14px;
        font-size: 1rem;
        color: #002ba3;
        text-decoration: none;
        display: inline-block;
        width: 250px;
      }

      .info-box {
        width: 100%;
        max-width: 800px;
        margin: 20px auto;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        border: 1px solid #ddd;
      }

      .info-box-download {
        width: 100%;
        max-width: 800px;
        margin: 0 auto 10px auto;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        display: none;
        border: 1px solid #ddd;
      }

      .download-header {
        text-align: center;
        font-size: 2rem;
        font-weight: bold;
        color: #002ba3;
        margin-bottom: 15px;
        padding: 0;
      }

      .download-info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        padding: 3px 0;
        border-bottom: 1px solid #eee;
      }

      .download-info-label {
        font-weight: bold;
        width: 40%;
        text-align: left;
        padding-right: 10px;
        font-size: 1.8rem;
      }

      .download-info-value {
        width: 60%;
        text-align: left;
        font-size: 1.4rem;
      }

      @media (max-width: 768px) {
        .image-container {
          width: 100vw;
        }
        .image-container img {
          min-width: 700px;
        }
        .motif-row {
          flex-direction: column;
          align-items: center;
          gap: 5px;
        }
        .lidi {
          font-size: 1rem;
          margin: 5px 0 0 5px;
          padding: 3px 10px;
        }
        .info-text {
          font-size: 1.1rem;
          margin: 5px 10px !important;
          padding: 3px 0 !important;
        }
        .title-text {
          font-size: 1.5rem;
        }
        #download-buttons {
          flex-direction: column;
          gap: 5px;
        }
        #download-buttons a {
          width: 100%;
          margin: 0 0 5px 0;
        }
        #back-button {
          margin-top: 5px;
        }
        #back-button a {
          width: 100%;
        }
        .info-box {
          max-width: 95%;
          padding: 10px;
        }
        .info-box-download {
          max-width: 95%;
          padding: 8px;
        }
        .download-header {
          font-size: 2.5rem;
          margin-bottom: 10px;
          text-align: left;
        }
        .download-info-row {
          flex-direction: column;
        }
        .download-info-label,
        .download-info-value {
          width: 100%;
          text-align: left;
          font-size: 1.2rem;
        }
      }
    </style>
  </head>
  <body>
    {% include "header.html" %}
    <br />
    <p class="title-text">Lembar Kerja Motif Tenun</p>
    
    <!-- Info box yang ditampilkan di halaman -->
    <div class="info-box">
      <p class="info-text">Nama Pembuat: {{ user }}</p>
      <p class="info-text">Tanggal Pembuatan: {{ date_now }}</p>
      <p class="info-text">Jenis Kain: {{ motif.jenisKain|default:"-" }}</p>
      <p class="info-text">
        Jenis Produk: {{ motif.jenisProduk|default:"-" }}
      </p>
      <p class="info-text">
        Ukuran: {% if motif.jenisProduk == 'sarung' %} Panjang 200-210 cm,
        Lebar 95-97 cm {% elif motif.jenisProduk == 'selendang' %} Panjang
        190-200 cm, Lebar 60-70 cm {% else %} - {% endif %}
      </p>
    </div>
    
    <!-- Info box yang akan dimasukkan ke dalam unduhan -->
    <div id="info-box-download" class="info-box-download">
      <div class="download-header">INFORMASI MOTIF TENUN</div>
      <div class="download-info-row">
        <div class="download-info-label">Nama Pembuat:</div>
        <div class="download-info-value">{{ user }}</div>
      </div>
      <div class="download-info-row">
        <div class="download-info-label">Tanggal Pembuatan:</div>
        <div class="download-info-value">{{ date_now }}</div>
      </div>
      <div class="download-info-row">
        <div class="download-info-label">Jenis Kain:</div>
        <div class="download-info-value">{{ motif.jenisKain|default:"-" }}</div>
      </div>
      <div class="download-info-row">
        <div class="download-info-label">Jenis Produk:</div>
        <div class="download-info-value">{{ motif.jenisProduk|default:"-" }}</div>
      </div>
      <div class="download-info-row">
        <div class="download-info-label">Ukuran:</div>
        <div class="download-info-value">
          {% if motif.jenisProduk == 'sarung' %} 
            Panjang 200-210 cm, Lebar 95-97 cm 
          {% elif motif.jenisProduk == 'selendang' %} 
            Panjang 190-200 cm, Lebar 60-70 cm 
          {% else %} - 
          {% endif %}
        </div>
      </div>
    </div>
    
    <div
      class="container"
      style="
        max-width: 100vw;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        margin: 0;
        padding: 0;
      "
    >
      <div
        id="image-section"
        style="
          width: 100%;
          display: flex;
          flex-direction: column;
          gap: 0;
          align-items: center;
          margin: 0;
          padding: 0;
        "
      >
        {% for Motif1, Motif2 in slice %}
        <div
          class="motif-row"
          style="gap: 0; margin: 0; padding: 0; line-height: 0"
        >
          <div
            class="image-container grid-overlay"
            style="width: 90%; margin: 0; padding: 0; flex-shrink: 0"
          >
            <img
              src="{{ Motif1 }}"
              data-nama-gambar="Lidi {{ Motif2 }}"
              onclick="openModal(this);"
              style="
                width: 100%;
                height: auto;
                object-fit: contain;
                margin: 0;
                padding: 0;
              "
            />
          </div>
          <div
            class="lidi"
            style="text-align: center; margin: 0; padding: 0; line-height: 0"
          >
            Lidi {{ Motif2 }}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <canvas id="canvasWrapper" style="width: 100%; height: auto" hidden></canvas
    ><br />
    <div class="download-container">
      <div id="download-buttons" style="margin: 0; padding: 0">
        <a class="btn btn-primary" onclick="renderDivToImage('png')"
          >Unduh Motif (PNG)</a
        >
        <a class="btn btn-primary" onclick="renderDivToImage('jpg')"
          >Unduh Motif (JPG)</a
        >
        <a class="btn btn-primary" onclick="renderDivToImage('pdf')"
          >Unduh Motif (PDF)</a
        >
      </div>
      <div id="back-button">
        <a
          class="btn btn-primary"
          href="/ubah_warna_combined/{{ motif.id }}"
          style="color: rgb(160, 160, 160)"
          >Kembali</a
        ><br />
      </div>
    </div>

    <img
      id="hiddenCombinedImage"
      src="{{ combined_image_url }}"
      style="display: none"
    />
    <br>

    {% include "footer.html" %}

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
      defer
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"
      defer
    ></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const { jsPDF } = window.jspdf;

        function renderDivToImage(format) {
          window.scrollTo(0, 0);
          
          // Tampilkan info box untuk diunduh
          const infoBoxDownload = document.getElementById("info-box-download");
          infoBoxDownload.style.display = "block";
          
          // Buat div baru untuk menangkap semua elemen yang ingin diunduh
          const captureDiv = document.createElement("div");
          captureDiv.id = "capture-div";
          captureDiv.style.width = "100%";
          captureDiv.style.margin = "0";
          captureDiv.style.padding = "10px 0 0 0";
          captureDiv.style.display = "flex";
          captureDiv.style.flexDirection = "column";
          captureDiv.style.alignItems = "center";
          
          // Tambahkan judul "LEMBAR KERJA MOTIF TENUN" di atas
          const titleDiv = document.createElement("div");
          titleDiv.style.textAlign = "center";
          titleDiv.style.marginBottom = "10px";
          const title = document.createElement("h1");
          title.style.color = "#002ba3";
          title.style.margin = "0";
          title.style.padding = "0";
          title.style.fontSize = "2rem";
          titleDiv.appendChild(title);
          
          captureDiv.appendChild(titleDiv);
          captureDiv.appendChild(infoBoxDownload.cloneNode(true));
          captureDiv.appendChild(document.getElementById("image-section").cloneNode(true));
          
          // Sembunyikan elemen asli
          infoBoxDownload.style.display = "none";
          
          // Tambahkan ke body sementara
          document.body.appendChild(captureDiv);

          const loadingIndicator = document.createElement("div");
          loadingIndicator.id = "loading-indicator";
          loadingIndicator.style.position = "fixed";
          loadingIndicator.style.top = "50%";
          loadingIndicator.style.left = "50%";
          loadingIndicator.style.transform = "translate(-50%, -50%)";
          loadingIndicator.style.padding = "20px";
          loadingIndicator.style.backgroundColor = "rgba(0, 0, 0, 0.8)";
          loadingIndicator.style.color = "white";
          loadingIndicator.style.borderRadius = "0px";
          loadingIndicator.style.zIndex = "1000";
          loadingIndicator.innerText = "Memproses...";
          document.body.appendChild(loadingIndicator);

          html2canvas(captureDiv, {
            scale: 4,
            useCORS: true,
            allowTaint: true,
            width: captureDiv.scrollWidth,
            height: captureDiv.scrollHeight,
            windowWidth: document.documentElement.scrollWidth,
            windowHeight: document.documentElement.scrollHeight,
          })
            .then((canvas) => {
              // Hapus elemen sementara
              document.body.removeChild(captureDiv);
              document.body.removeChild(loadingIndicator);

              if (format === "pdf") {
                const pdf = new jsPDF("p", "mm", "a4");

                const imgData = canvas.toDataURL("image/jpeg", 0.8);
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                const imgWidth = canvas.width * 0.264583;
                const imgHeight = imgWidth * (canvas.height / canvas.width);

                const scaleFactor = Math.min(
                  pageWidth / imgWidth,
                  (pageHeight - 140) / imgHeight
                );

                const scaledWidth = imgWidth * scaleFactor;
                const scaledHeight = imgHeight * scaleFactor;

                const xOffset = (pageWidth - scaledWidth) / 2;
                const yOffset = 55;

                // Logo diposisikan
                pdf.addImage("/{{ ditenun_logo_1 }}", "PNG", 20, 20, 30, 30);
                pdf.addImage(
                  "/{{ ditenun_logo_2 }}",
                  "PNG",
                  pageWidth - 50,
                  20,
                  30,
                  30
                );

                pdf.setFontSize(20);
                pdf.text("LEMBAR KERJA MOTIF TENUN", pageWidth / 2, 40, {
                  align: "center",
                });

                // Garis lurus horizontal di bagian bawah header
                pdf.setDrawColor(0, 0, 0); // Warna hitam
                pdf.setLineWidth(0.9); // Ketebalan garis
                pdf.line(30, 55, pageWidth - 30, 55); // Garis horizontal


                pdf.addImage(
                  imgData,
                  "JPEG",
                  xOffset,
                  yOffset,
                  scaledWidth,
                  scaledHeight
                );

                pdf.save(`lembar_kerja_motif_tenun_${new Date().toISOString().slice(0,10)}.pdf`);
              } else {
                const link = document.createElement("a");
                link.href = canvas.toDataURL(`image/${format}`, 0.8);
                link.download = `lembar_kerja_motif_tenun_${new Date().toISOString().slice(0,10)}.${format}`;
                link.click();
              }
            })
            .catch((error) => {
              document.body.removeChild(loadingIndicator);
              document.body.removeChild(captureDiv);
              console.error("Kesalahan saat membuat gambar:", error);
              alert("Terjadi kesalahan saat membuat unduhan. Silakan coba lagi.");
            });
        }

        window.renderDivToImage = renderDivToImage;

        const submitCanvasImages = () => {
          console.log("Fungsi submitCanvasImages belum diimplementasikan.");
        };
        window.submitCanvasImages = submitCanvasImages;
      });
    </script>
  </body>
</html>