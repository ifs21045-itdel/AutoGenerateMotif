<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}" />
    <link
      rel="icon"
      href="{% static 'img/icon/NewTitle.ico'%}"
      type="image/x-icon"
    />
    <link rel="stylesheet" href="{% static 'templatemo-style.css'%}" />
    <link rel="stylesheet" href="{% static 'image.css'%}" />

    <title>Pratinjau Gabungan Motif</title>

    <style>
      .image-container {
        width: 100vw;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .image-container img {
        width: 100%;
        height: auto;
        object-fit: contain;
        min-width: 1200px;
      }

      .container {
        display: flex;
        flex-direction: column;
        gap: 0;
        align-items: center;
        margin: 0 !important;
        padding: 0 !important;
      }

      .image-container div {
        text-align: center;
      }

      .lidi {
        text-align: center;
        margin: 5px 0 0 10px;
        padding: 5px 15px;
        font-size: 0.8rem;
        line-height: 1.2;
        font-weight: bold;
        color: #333;
        background-color: #f8f9fa;
        white-space: nowrap;
      }

      #download-buttons a {
        margin: 0 5px;
        padding: 12px 24px;
        font-size: 1.2rem;
        text-align: center;
        width: 250px;
        border-radius: 0px;
      }

      .title-text {
        font-size: 3rem;
        font-weight: bold;
        color: #0d6efd;
        text-align: center;
        margin: 0 !important;
        padding: 0 !important;
      }

      .info-text {
        text-align: left;
        margin: 0 !important;
        padding: 2px 0 !important;
        font-size: 1.5rem;
        font-weight: normal;
        color: #333;
      }

      #image-section {
        margin: 0 !important;
        padding: 0 !important;
      }

      #image-section p:first-child {
        margin-top: 0 !important;
      }

      .motif-row {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin: 0;
        padding: 0;
        width: 100%;
      }

      .lidi-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 150px;
      }

      .download-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        margin: 0;
        padding: 0;
      }

      #download-buttons {
        display: flex;
        flex-direction: row;
        gap: 10px;
        align-items: center;
        margin: 0;
        padding: 0;
      }

      #back-button {
        display: flex;
        justify-content: center;
        width: 100%;
        margin-top: 10px;
        padding: 0;
        border-radius: 0px;
      }

      #back-button a {
        background-color: transparent;
        border: 2px solid #002ba3;
        border-radius: 0px;
        padding: 12px 30px 14px;
        font-size: 1rem;
        color: #002ba3;
        text-decoration: none;
        display: inline-block;
        width: 250px;
      }

      @media (max-width: 768px) {
        .image-container {
          width: 100vw;
        }
        .image-container img {
          min-width: 700px;
        }
        .motif-row {
          flex-direction: column;
          align-items: center;
          gap: 5px;
        }
        .lidi {
          font-size: 0.7rem;
          margin: 5px 0 0 5px;
          padding: 3px 10px;
        }
        .info-text {
          font-size: 0.9rem;
          margin: 0 !important;
          padding: 1px 0 !important;
        }
        .title-text {
          font-size: 1.2rem;
        }
        #download-buttons {
          flex-direction: column;
          gap: 5px;
        }
        #download-buttons a {
          width: 100%;
          margin: 0 0 5px 0;
        }
        #back-button {
          margin-top: 5px;
        }
        #back-button a {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    {% include "header.html" %}
    <br />
    <p class="title-text">Hasil Motif</p>
    <br />
    <div
      class="container"
      style="
        max-width: 100vw;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        margin: 0;
        padding: 0;
      "
    >
      <div
        id="image-section"
        style="
          width: 100%;
          display: flex;
          flex-direction: column;
          gap: 0;
          align-items: center;
          margin: 0;
          padding: 0;
        "
      >
        <p class="info-text">Nama Pembuat: {{ user }}</p>
        <p class="info-text">Tanggal Pembuatan: {{ date_now }}</p>
        <p class="info-text">Jenis Kain: {{ motif.jenisKain|default:"-" }}</p>
        <p class="info-text">
          Jenis Produk: {{ motif.jenisProduk|default:"-" }}
        </p>
        <p class="info-text">
          Ukuran: {% if motif.jenisProduk == 'sarung' %} Panjang 200-210 cm,
          Lebar 95-97 cm {% elif motif.jenisProduk == 'selendang' %} Panjang
          190-200 cm, Lebar 60-70 cm {% else %} - {% endif %}
        </p>
        <br />
        {% for Motif1, Motif2 in slice %}
        <div
          class="motif-row"
          style="gap: 0; margin: 0; padding: 0; line-height: 0"
        >
          <div
            class="image-container grid-overlay"
            style="width: 90%; margin: 0; padding: 0; flex-shrink: 0"
          >
            <img
              src="{{ Motif1 }}"
              data-nama-gambar="Lidi {{ Motif2 }}"
              onclick="openModal(this);"
              style="
                width: 100%;
                height: auto;
                object-fit: contain;
                margin: 0;
                padding: 0;
              "
            />
          </div>
          <div
            class="lidi"
            style="text-align: center; margin: 0; padding: 0; line-height: 0"
          >
            Lidi {{ Motif2 }}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <canvas id="canvasWrapper" style="width: 100%; height: auto" hidden></canvas
    ><br />
    <div class="download-container">
      <div id="download-buttons" style="margin: 0; padding: 0">
        <a class="btn btn-primary" onclick="renderDivToImage('png')"
          >Unduh Motif (PNG)</a
        >
        <a class="btn btn-primary" onclick="renderDivToImage('jpg')"
          >Unduh Motif (JPG)</a
        >
        <a class="btn btn-primary" onclick="renderDivToImage('pdf')"
          >Unduh Motif (PDF)</a
        >
      </div>
      <div id="back-button">
        <a
          class="btn btn-primary"
          href="/ubah_warna_combined/{{ motif.id }}"
          style="color: rgb(160, 160, 160)"
          >Kembali</a
        ><br />
      </div>
    </div>

    <img
      id="hiddenCombinedImage"
      src="{{ combined_image_url }}"
      style="display: none"
    />
    <br>

    {% include "footer.html" %}

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
      defer
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"
      defer
    ></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const { jsPDF } = window.jspdf;

        function renderDivToImage(format) {
          window.scrollTo(0, 0); // Pastikan posisi awal halaman di atas
          const section = document.getElementById("image-section");

          const loadingIndicator = document.createElement("div");
          loadingIndicator.id = "loading-indicator";
          loadingIndicator.style.position = "fixed";
          loadingIndicator.style.top = "50%";
          loadingIndicator.style.left = "50%";
          loadingIndicator.style.transform = "translate(-50%, -50%)";
          loadingIndicator.style.padding = "20px";
          loadingIndicator.style.backgroundColor = "rgba(0, 0, 0, 0.8)";
          loadingIndicator.style.color = "white";
          loadingIndicator.style.borderRadius = "0px";
          loadingIndicator.style.zIndex = "1000";
          loadingIndicator.innerText = "Memproses...";
          document.body.appendChild(loadingIndicator);

          html2canvas(section, {
            scale: 4,
            useCORS: true,
            allowTaint: true,
            width: section.scrollWidth,
            height: section.scrollHeight,
            windowWidth: document.documentElement.scrollWidth,
            windowHeight: document.documentElement.scrollHeight,
          })
            .then((canvas) => {
              document.body.removeChild(loadingIndicator);

              if (format === "pdf") {
                const pdf = new jsPDF("p", "mm", "a4");

                const imgData = canvas.toDataURL("image/jpeg", 0.8);
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                const imgWidth = canvas.width * 0.264583;
                const imgHeight = imgWidth * (canvas.height / canvas.width);

                const scaleFactor = Math.min(
                  pageWidth / imgWidth,
                  (pageHeight - 100) / imgHeight
                );

                const scaledWidth = imgWidth * scaleFactor;
                const scaledHeight = imgHeight * scaleFactor;

                const xOffset = (pageWidth - scaledWidth) / 2;
                const yOffset = 60;

                pdf.addImage("/{{ ditenun_logo_1 }}", "PNG", 20, 10, 30, 30);
                pdf.addImage(
                  "/{{ ditenun_logo_2 }}",
                  "PNG",
                  pageWidth - 50,
                  10,
                  30,
                  30
                );

                pdf.setFontSize(20);
                pdf.text("Lembar Kerja Penenun", pageWidth / 2, 25, {
                  align: "center",
                });

                const logoBottom = 10 + 30;
                pdf.line(30, logoBottom + 10, pageWidth - 30, logoBottom + 10);

                pdf.addImage(
                  imgData,
                  "JPEG",
                  xOffset,
                  yOffset + 20,
                  scaledWidth,
                  scaledHeight
                );

                pdf.save("motif_combined.pdf");
              } else {
                const link = document.createElement("a");
                link.href = canvas.toDataURL(`image/${format}`, 0.8);
                link.download = `motif_image.${format}`;
                link.click();
              }
            })
            .catch((error) => {
              document.body.removeChild(loadingIndicator);
              console.error("Kesalahan saat membuat gambar:", error);
            });
        }

        window.renderDivToImage = renderDivToImage;

        const submitCanvasImages = () => {
          console.log("Fungsi submitCanvasImages belum diimplementasikan.");
        };
        window.submitCanvasImages = submitCanvasImages;
      });
    </script>
  </body>
</html>
