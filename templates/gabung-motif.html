<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}" />
    <title>Modul Lidi</title>
    <link
      rel="icon"
      href="{% static 'img/icon/NewTitle.ico' %}"
      type="image/x-icon"
    />
    <style>
      /* Menyesuaikan ukuran gambar motif */
      .motif-size {
        width: 100%;
        height: auto;
        object-fit: contain;
        margin-bottom: 10px; /* Jarak antara gambar */
        position: relative;
      }

      .motif-number {
        position: absolute;
        top: 5px;
        left: 5px;
        background-color: blue;
        color: white;
        font-size: 16px;
        font-weight: bold;
        padding: 5px;
        border-radius: 0px;
        width: 30px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* Styling untuk container Motif */
      .motif-container {
        margin-top: 20px; /* Add space above the container */
        border: 3px solid #000000; /* Increase border width */
        border-radius: 10px; /* Increase border radius for rounder corners */
        padding: 20px; /* Increase padding inside the container */
        background-color: #f5f5f5;
        height: 2250px; /* Increase height */
      }
      /* Styling untuk judul container */
      .motif-container h5 {
        color: rgb(0, 0, 0);
        font-weight: bold;
      }

      .mirror-line {
        /* Garis merah pembatas cermin */
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 2px;
        background-color: red;
        z-index: 1;
      }

      .combined-motif-container img {
        width: 100%; /* Menyesuaikan ukuran gambar */
        max-width: 500px; /* Membatasi lebar maksimal agar lebih terkontrol */
        height: auto;
        object-fit: contain;
        margin-bottom: 20px;
        margin-top: 20px;
      }

      .image-container {
        position: relative;
        width: 100%;
      }

      .combined-motif-container {
        height: auto;
        min-height: 2160px; /* Make it take up full height */
        width: 100%;
        overflow-y: auto;
        padding: 20px; /* Increase padding to give more space */
        background-color: white;
        border: 1px solid #ddd;
        padding-top: 40px; /* Increase top padding */
        align-items: center;
        max-height: 100%;
        position: relative;
        margin-top: 20px;
        display: flex; /* Use grid layout */
        flex-direction: column;
        grid-template-columns: 1fr;
        grid-auto-rows: minmax(150px, auto);
        /* Make sure columns take more space */
        gap: 20px; /* Add more space between images */
        justify-items: center; /* Center the items within the grid cells */
      }

      .combined-motif-container div {
        position: relative;
        width: 100%; /* Make sure the images fill the container */
      }

      /* Card untuk Motif */
      .motif-card {
        margin-bottom: 15px; /* More space between cards */
        border: 2px solid #000000;
        border-radius: 0px;
        padding: 10px;
        background-color: #f9f9f9;
      }

      .main-title {
        font-size: 36px; /* Larger font size for the title */
        text-align: center;
        margin-top: 20px;
        margin-bottom: 30px; /* Add space below the title */
      }

      .motif-container,
      .combined-motif-container {
        width: 100%; /* Make sure all containers take full width */
      }

      /* Menambahkan margin untuk tombol agar lebih ke bawah */
      .btn-container {
        margin-top: 60px; /* More space between buttons */
      }

      .motif-item {
        display: flex;
        flex-direction: column;
        gap: 20px; /* Jarak antara gambar atas dan bawah */
        position: relative;
        cursor: pointer;
      }

      .container {
        max-width: 100%; /* Ensure the container takes full width */
        padding-left: 20px; /* Add space to the left */
        padding-right: 20px; /* Add space to the right */
      }

      .card-1 {
        padding: 20px; /* Increase padding inside the card */
        width: 100%; /* Ensure the card takes the full width */
      }

      /* Adjust the column width inside the container */
      .row {
        width: 100%;
      }

      .motif-pair-container {
        display: flex;
        flex-direction: column;
        gap: 20px; /* Jarak antara gambar atas dan bawah */
        position: relative;
        width: 100%;
        max-width: 500px;
        margin-bottom: 80px;
      }

      .motif-pair {
        position: relative;
        width: 100%;
      }

      .motif-pair img {
        width: 100%;
        height: auto;
        object-fit: contain;
        border: 1px solid #ddd;
      }

      /* Menambahkan garis horizontal merah pada tengah container */
    </style>
  </head>
  <body>
    <div class="container card-0 justify-content-center">
      <div class="card-body px-sm-4 px-0">
        <!-- Judul Utama Modul Lidi -->
        <div class="row justify-content-center mb-5">
          <div class="col-md-10">
            <h3 class="main-title">Modul Lidi</h3>
            <p class="text-center text-white">
              Modul Lidi membantu penenun menghasilkan berbagai motif hanya
              dengan menggunakan sedikit Lidi. Motif yang dihasilkan telah
              teruji mampu menciptakan hingga ratusan motif dengan 8 jenis Lidi.
              Motif ini dapat diterapkan secara pasti pada kain tenun ulos.
            </p>
          </div>
        </div>

        <div class="row justify-content-center round">
          <div class="col-lg-10 col-md-12">
            <div class="card shadow-lg card-1">
              <div class="card-body inner-card">
                <div class="row">
                  <!-- Kolom untuk Menampilkan Motif Asal dan Hasil Motif -->
                  <div class="col-md-6 text-center">
                    <h5 class="motif-title">Motif</h5>
                    <p class="explanation-text">
                      Klik pada motif yang ingin dipilih. Anda dapat memilih
                      lebih dari satu motif untuk digabungkan dalam motif yang
                      sama.
                    </p>
                    <div class="motif-container">
                      <h5>Motif Asal</h5>
                      <div class="card motif-card">
                        <img
                          src="{{ raw_url }}"
                          class="card-img-top motif-size"
                          alt="Motif Asal"
                          onclick="addMotif(this)"
                        />
                      </div>

                      <h5>Hasil Motif 1</h5>
                      <div class="card motif-card">
                        <img
                          src="{{ edit_url }}"
                          class="card-img-top motif-size"
                          alt="Hasil Motif 1"
                          onclick="addMotif(this)"
                        />
                      </div>

                      <h5>Hasil Motif 2</h5>
                      <div class="card motif-card">
                        <img
                          src="{{ edit_url2 }}"
                          class="card-img-top motif-size"
                          alt="Hasil Motif 2"
                          onclick="addMotif(this)"
                        />
                      </div>

                      <h5>Hasil Motif 3</h5>
                      <div class="card motif-card">
                        <img
                          src="{{ edit_url3 }}"
                          class="card-img-top motif-size"
                          alt="Hasil Motif 3"
                          onclick="addMotif(this)"
                        />
                      </div>

                      <h5>Hasil Motif 4</h5>
                      <div class="card motif-card">
                        <img
                          src="{{ edit_url4 }}"
                          class="card-img-top motif-size"
                          alt="Hasil Motif 4"
                          onclick="addMotif(this)"
                        />
                      </div>
                    </div>
                  </div>

                  <!-- Kolom untuk Menampilkan Motif yang Digabungkan -->
                  <div class="col-md-6 text-center">
                    <h5 class="combined-title">Penggabungan Motif</h5>
                    <p class="explanation-text">
                      Jika Anda ingin menghapus motif yang telah dipilih, Anda
                      dapat mengklik motif yang ingin dihapus.
                    </p>
                    <div class="motif-container">
                      <div
                        id="combinedMotifContainer"
                        class="combined-motif-container"
                      >
                        <p class="text-muted">Belum ada motif yang dipilih.</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Tombol Simpan dan Modal -->
                <div class="btn-container row mt-4 text-center">
                  <div class="col-md-12">
                    <button
                      class="btn"
                      onclick="saveMotif()"
                      style="
                        background-color: #002ba3;
                        border: 2px solid #002ba3;
                        border-radius: 0px;
                        padding: 12px 30px 14px;
                        font-size: 1rem;
                        color: #ffffff;
                        display: inline-block;
                        width: 320px;
                      "
                    >
                      Simpan Motif
                    </button>
                  </div>
                </div>

                <div
                  class="modal fade"
                  id="successModal"
                  tabindex="-1"
                  aria-labelledby="exampleModalLabel"
                  aria-hidden="true"
                >
                  <div class="modal-dialog modal-sm">
                    <div class="modal-content" style="border: none">
                      <div
                        class="modal-header d-flex justify-content-center flex-column align-items-center"
                        style="
                          border-bottom: none;
                          position: relative;
                          padding: 0;
                        "
                      >
                        <img
                          src="{% static 'img/icon/checkmark.png' %}"
                          alt="Success"
                          style="width: 140px; margin-bottom: 0"
                        />
                        <div
                          class="modal-body text-center"
                          style="border-bottom: none; padding: 0; margin-top: 0"
                        >
                          Motif Berhasil Dibuat
                        </div>
                      </div>
                      <div
                        class="modal-footer d-flex justify-content-center"
                        style="border-top: none; padding-top: 1"
                      >
                        <button
                          type="button"
                          class="btn btn-primary"
                          onclick="redirectToList()"
                        >
                          Lihat Motif
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Button Back -->
                <div class="btn-container row mt-4 text-center">
                  <div class="col-md-12">
                    <a
                      href="{% url 'generator' %}"
                      class="btn"
                      style="
                        background-color: transparent;
                        border: 2px solid #002ba3;
                        border-radius: 0px;
                        padding: 12px 30px 14px;
                        font-size: 1rem;
                        color: #002ba3;
                        text-decoration: none;
                        display: inline-block;
                        width: 320px;
                      "
                    >
                      Kembali
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

      <script>
        // Fungsi untuk menyimpan motif
        // function saveMotif() {
        //   // Mengirim data motif yang dipilih ke server atau melakukan proses penyimpanan
        //   // Setelah sukses, modal akan muncul
        //   var successModal = new bootstrap.Modal(
        //     document.getElementById("successModal")
        //   );
        //   successModal.show();
        // }

        function redirectToList() {
          window.location.href = "{% url 'list1' %}";
        }

        let motifCounter = 1; // Untuk melacak urutan gambar

        // Fungsi untuk menambahkan motif yang dipilih ke dalam container
        function addMotif(imageElement) {
          var combinedMotifContainer = document.getElementById(
            "combinedMotifContainer"
          );

          // Menghapus pesan "Belum ada motif yang dipilih"
          if (
            combinedMotifContainer.innerHTML.includes(
              "Belum ada motif yang dipilih"
            )
          ) {
            combinedMotifContainer.innerHTML = "";
          }

          // Menghitung jumlah total motif yang sudah ditambahkan
          var totalMotifs = combinedMotifContainer.children.length / 2;

          // Menentukan posisi untuk gambar pertama (di atas)
          var positionOffset = totalMotifs * 100;
          var topPosition = `calc(50% - ${50 + positionOffset + 40}px)`; // Menambah jarak pada posisi atas
          var bottomPosition = `calc(50% + ${50 + positionOffset + 60}px)`; // Posisi bawah tetap

          // Membuat elemen gambar pertama
          var img = document.createElement("img");
          img.src = imageElement.src;
          img.className = "motif-size";
          img.style.maxWidth = "500px";
          img.dataset.index = motifCounter;
          img.onclick = function () {
            removeMotif(this);
          };

          // Fungsi addMotif yang diperbaiki:
          const bottomImg = document.createElement("img");
          bottomImg.src = imageElement.src;
          bottomImg.className = "motif-size";
          bottomImg.style.transform = "scaleY(-1)"; // Efek cermin yang benar
          bottomImg.dataset.index = motifCounter;

          // Membuat elemen angka untuk ditampilkan di gambar
          var numberLabel = document.createElement("span");
          numberLabel.className = "motif-number";
          numberLabel.textContent = motifCounter;

          const motifItem = document.createElement("div");
          motifItem.className = "motif-item";
          motifItem.dataset.index = motifCounter;

          // Fungsi pembantu untuk membuat elemen
          const createImage = (src, transform) => {
            const img = document.createElement("img");
            img.src = src;
            img.className = "motif-size";
            img.style.transform = transform || "";
            return img;
          };

          // Membuat elemen container untuk gambar pertama
          var imgContainer = document.createElement("div");
          imgContainer.style.position = "absolute";
          imgContainer.style.marginBottom = "20px";
          imgContainer.style.left = "50%";
          imgContainer.style.transform = "translateX(-50%)"; // Center the image horizontally
          imgContainer.style.top = topPosition;

          imgContainer.appendChild(img);
          imgContainer.appendChild(numberLabel);

          // Menambahkan gambar pertama ke dalam kontainer penggabungan
          combinedMotifContainer.appendChild(imgContainer);

          // Membuat elemen gambar kedua (untuk gambar kedua)
          var imgDouble = document.createElement("img");
          imgDouble.src = imageElement.src;
          imgDouble.className = "motif-size";
          imgDouble.dataset.index = motifCounter;
          imgDouble.onclick = function () {
            removeMotif(this);
          };

          var numberLabelDouble = document.createElement("span");
          numberLabelDouble.className = "motif-number";
          numberLabelDouble.textContent = motifCounter;

          // Membuat elemen container untuk gambar kedua
          var imgContainerDouble = document.createElement("div");
          imgContainerDouble.style.position = "absolute";
          imgContainerDouble.style.left = "50%";
          imgContainerDouble.style.transform = "translateX(-50%)";
          imgContainerDouble.style.top = bottomPosition;

          imgContainerDouble.appendChild(imgDouble);
          imgContainerDouble.appendChild(numberLabelDouble);

          // Menambahkan gambar kedua ke dalam kontainer penggabungan
          combinedMotifContainer.appendChild(imgContainerDouble);

          motifCounter++;
        }

        function removeMotif(motifElement) {
          // Ambil nilai dataset index dari motif yang diklik
          let indexToRemove = motifElement.dataset.index;
          let motifCounter = 1; // Untuk melacak urutan gambar

          // Fungsi untuk menambahkan motif yang dipilih ke dalam container
          function addMotif(imageElement) {
            var combinedMotifContainer = document.getElementById(
              "combinedMotifContainer"
            );

            // Cek apakah ada pesan "Belum ada motif yang dipilih", jika ada, hapus
            if (
              combinedMotifContainer.innerHTML.includes(
                "Belum ada motif yang dipilih"
              )
            ) {
              combinedMotifContainer.innerHTML = ""; // Hapus pesan tersebut
            }

            // Menghitung jumlah total motif yang sudah ditambahkan
            var totalMotifs = combinedMotifContainer.children.length / 2; // Membagi 2 karena ada 2 gambar per motif (atas dan bawah)

            // Menentukan posisi untuk gambar pertama (gambar yang akan tampil di atas)
            var positionOffset = totalMotifs * 150; // Menambah jarak vertikal antar gambar

            var topPosition = `${positionOffset}px`; // Jarak posisi atas
            var bottomPosition = `${positionOffset + 150}px`; // Jarak posisi bawah

            // Membuat elemen gambar pertama (untuk gambar baru)
            var img = document.createElement("img");
            img.src = imageElement.src;
            img.className = "motif-size"; // Gambar dengan kelas yang sudah disesuaikan
            img.dataset.index = motifCounter; // Menambahkan atribut untuk urutan gambar
            img.onclick = function () {
              removeMotif(this);
            };

            // Membuat elemen angka untuk ditampilkan di gambar
            var numberLabel = document.createElement("span");
            numberLabel.className = "motif-number";
            numberLabel.textContent = motifCounter; // Menambahkan angka

            // Membuat elemen container untuk gambar pertama dan angka
            var imgContainer = document.createElement("div");
            imgContainer.style.position = "absolute"; // Menggunakan absolute positioning
            imgContainer.style.left = "50%"; // Menempatkan gambar di tengah horizontal
            imgContainer.style.transform = "translateX(-50%)"; // Menjaga agar gambar tetap berada di tengah

            // Menempatkan gambar pertama di bagian atas
            imgContainer.style.top = topPosition;
            imgContainer.appendChild(img);
            imgContainer.appendChild(numberLabel);

            // Menambahkan gambar pertama ke dalam kontainer penggabungan (untuk bagian atas)
            combinedMotifContainer.appendChild(imgContainer);

            // Membuat elemen gambar kedua (untuk gambar baru)
            var imgDouble = document.createElement("img");
            imgDouble.src = imageElement.src;
            imgDouble.className = "motif-size"; // Gambar dengan kelas yang sudah disesuaikan
            imgDouble.dataset.index = motifCounter; // Memberikan angka yang sama
            imgDouble.onclick = function () {
              removeMotif(this);
            };

            var numberLabelDouble = document.createElement("span");
            numberLabelDouble.className = "motif-number";
            numberLabelDouble.textContent = motifCounter; // Menambahkan angka yang sama untuk gambar kedua

            // Membuat elemen container untuk gambar kedua dan angka
            var imgContainerDouble = document.createElement("div");
            imgContainerDouble.style.position = "absolute"; // Menggunakan absolute positioning
            imgContainerDouble.style.left = "50%"; // Menempatkan gambar di tengah horizontal
            imgContainerDouble.style.transform = "translateX(-50%)"; // Menjaga agar gambar tetap berada di tengah

            // Menempatkan gambar kedua di bagian bawah
            imgContainerDouble.style.top = bottomPosition;
            imgContainerDouble.appendChild(imgDouble);
            imgContainerDouble.appendChild(numberLabelDouble);

            // Menambahkan gambar kedua ke dalam kontainer penggabungan (untuk bagian bawah)
            combinedMotifContainer.appendChild(imgContainerDouble);

            motifCounter++; // Menambah urutan gambar hanya 1 kali
          }
          let combinedMotifContainer = document.getElementById(
            "combinedMotifContainer"
          );

          // Ambil seluruh container di dalam combinedMotifContainer
          let motifContainers = Array.from(combinedMotifContainer.children);

          // Hapus semua container yang memiliki gambar dengan dataset index yang sama
          motifContainers.forEach((container) => {
            let img = container.querySelector("img");
            if (img && img.dataset.index === indexToRemove) {
              container.remove();
            }
          });

          // Jika kontainer gabungan sudah kosong, tampilkan notifikasi kembali
          if (combinedMotifContainer.children.length === 0) {
            let notif = document.createElement("p");
            notif.className = "text-muted";
            notif.textContent = "Belum ada motif yang dipilih.";
            combinedMotifContainer.appendChild(notif);
          }
        }
        function saveMotif() {
          // Ambil container motif yang digabungkan
          var combinedMotifContainer = document.getElementById(
            "combinedMotifContainer"
          );

          // Cek apakah ada motif yang dipilih
          if (
            combinedMotifContainer.children.length === 0 ||
            combinedMotifContainer.innerHTML.includes(
              "Belum ada motif yang dipilih"
            )
          ) {
            alert("Pilih motif terlebih dahulu!");
            return;
          }

          // Fungsi untuk memuat gambar
          function loadImage(src) {
            return new Promise((resolve, reject) => {
              var img = new Image();
              img.onload = () => resolve(img);
              img.onerror = reject;
              img.src = src;
            });
          }

          // Fungsi untuk mendapatkan CSRF token
          function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
              const cookies = document.cookie.split(";");
              for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === name + "=") {
                  cookieValue = decodeURIComponent(
                    cookie.substring(name.length + 1)
                  );
                  break;
                }
              }
            }
            return cookieValue;
          }

          // Proses menggabungkan gambar
          async function combineMotifs() {
            try {
              // Ambil semua kontainer gambar yang berisi gambar
              var motifContainers = Array.from(
                combinedMotifContainer.children
              ).filter((container) => container.querySelector("img"));

              // Kelompokkan gambar berdasarkan posisi (atas/bawah)
              const topImages = [];
              const bottomImages = [];

              motifContainers.forEach((container) => {
                const img = container.querySelector("img");
                // Pisahkan gambar berdasarkan posisi top
                if (container.style.top.includes("-")) {
                  topImages.push(img);
                } else {
                  bottomImages.push(img);
                }
              });

              // Hitung total tinggi yang dibutuhkan
              async function calculateTotalHeight(images, containerWidth) {
                let totalHeight = 0;
                for (let img of images) {
                  const loadedImg = await loadImage(img.src);
                  const scale = containerWidth / loadedImg.width;
                  totalHeight += loadedImg.height * scale + 20; // Tambah sedikit jarak
                }
                return totalHeight;
              }

              // Tentukan lebar canvas
              const canvasWidth = 800; // Lebar tetap

              // Hitung total tinggi gambar
              const topImagesHeight = await calculateTotalHeight(
                topImages,
                canvasWidth
              );
              const bottomImagesHeight = await calculateTotalHeight(
                bottomImages,
                canvasWidth
              );

              // Total tinggi canvas disesuaikan dengan motif
              const canvasHeight = topImagesHeight + bottomImagesHeight + 40; // Tambah sedikit margin

              // Pastikan tinggi canvas adalah kelipatan 10 untuk grid yang tepat
              const adjustedCanvasHeight = Math.ceil(canvasHeight / 10) * 10;

              // Buat canvas dengan ukuran yang tepat
              let canvas = document.createElement("canvas");
              canvas.width = canvasWidth;
              canvas.height = adjustedCanvasHeight;
              let ctx = canvas.getContext("2d");

              // Warnai background canvas dengan putih
              ctx.fillStyle = "white";
              ctx.fillRect(0, 0, canvas.width, canvas.height);

              // Mulai dari atas
              let yOffset = 20; // Sedikit margin dari atas

              // Fungsi untuk menggambar gambar
              async function drawImages(images, reverse = false) {
                const imagesToDraw = reverse
                  ? images.slice().reverse()
                  : images;

                for (let img of imagesToDraw) {
                  var loadedImg = await loadImage(img.src);

                  // Hitung skala agar gambar muat di canvas
                  var scale = canvas.width / loadedImg.width;
                  var scaledHeight = loadedImg.height * scale;

                  // Gambar di tengah canvas dengan skala persis seperti di grid
                  var xPosition = 0;
                  ctx.drawImage(
                    loadedImg,
                    xPosition,
                    yOffset,
                    canvas.width,
                    scaledHeight
                  );

                  // Geser posisi untuk gambar selanjutnya sesuai posisi di grid
                  yOffset += scaledHeight + 20; // Tambah sedikit jarak antar gambar
                }
              }

              // Gambar bagian atas
              await drawImages(topImages);

              // Gambar bagian bawah dalam urutan terbalik
              await drawImages(bottomImages, true);

              // Konversi ke hitam-putih dengan kontras tinggi untuk mendapatkan hasil yang jelas
              const imgData = ctx.getImageData(
                0,
                0,
                canvas.width,
                canvas.height
              );
              const data = imgData.data;

              // Proses setiap piksel untuk konversi ke hitam-putih
              for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                // Threshold yang lebih agresif untuk binarisasi yang jelas
                const threshold = 200; // Nilai lebih tinggi menghasilkan lebih banyak area putih
                const newVal = avg > threshold ? 255 : 0;

                data[i] = newVal; // R
                data[i + 1] = newVal; // G
                data[i + 2] = newVal; // B
                // Alpha tetap sama
              }

              // Pasang kembali data yang sudah diproses
              ctx.putImageData(imgData, 0, 0);

              // Dapatkan data URL dari canvas
              const dataURL = canvas.toDataURL("image/png");

              // Hitung jumlah baris berdasarkan tinggi canvas
              // Gunakan grid size 10px seperti di kode asli
              const pixelsPerRow = 10; // Sesuai dengan grid di kode asli
              const rowCount = Math.max(
                Math.floor(adjustedCanvasHeight / pixelsPerRow),
                8
              ); // Minimal 8 baris

              // Buat urutan lidi dasar
              let basicLidiSequence = [];
              for (let i = 1; i <= rowCount; i++) {
                basicLidiSequence.push(i);
              }

              // Terapkan pola urutan seperti di CreateImageModule.py
              let lidiSequence = [];
              if (rowCount % 2 === 0) {
                // Pola untuk jumlah baris genap (seperti di imageEven)
                const c = [...basicLidiSequence];
                const reversed = c.reverse();
                lidiSequence = [...basicLidiSequence, ...reversed];
              } else {
                // Pola untuk jumlah baris ganjil (seperti di imageOdd)
                const temp = basicLidiSequence.pop();
                const c = [...basicLidiSequence];
                const reversed = c.reverse();
                lidiSequence = [...basicLidiSequence, temp, ...reversed];
              }

              // Konversi ke string untuk dikirim ke server
              const lidiString = lidiSequence.join(",");

              // PERBAIKAN: Gunakan FormData untuk mengirim gambar
              const formDataUpload = new FormData();
              formDataUpload.append(
                "file",
                dataURLtoBlob(dataURL),
                "combined_motif.png"
              );
              formDataUpload.append(
                "csrfmiddlewaretoken",
                getCookie("csrftoken")
              );

              // PERBAIKAN: Mengubah dataURL menjadi Blob
              function dataURLtoBlob(dataURL) {
                const arr = dataURL.split(",");
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) {
                  u8arr[n] = bstr.charCodeAt(n);
                }
                return new Blob([u8arr], { type: mime });
              }

              // PERBAIKAN: Upload gambar menggunakan FormData
              const imageUploadResponse = await fetch("/upload_image/", {
                method: "POST",
                body: formDataUpload,
                headers: {
                  "X-CSRFToken": getCookie("csrftoken"),
                  // PERBAIKAN: Hapus Content-Type agar browser mengatur boundary dengan benar
                },
              });

              if (!imageUploadResponse.ok) {
                const errorData = await imageUploadResponse.text();
                throw new Error("Gagal mengupload gambar: " + errorData);
              }

              // Ambil data path dari respons server
              const imageData = await imageUploadResponse.json();
              const imagePath = imageData.imageUrl; // PERBAIKAN: Menggunakan nama properti yang benar

              // Gunakan data username jika tersedia, jika tidak gunakan nilai default
              const username =
                document.body.getAttribute("data-username") ||
                "{{ request.user.username }}" ||
                "anonymous";

              // Kini gunakan path gambar dan urutan lidi untuk menyimpan motif
              const formData = new FormData();
              formData.append(
                "imgBefore",
                document.querySelector(".motif-card img").src
              );
              formData.append("imgAfter", imagePath);
              formData.append("urutanLidi", lidiString);
              formData.append("jenisGenerate", "combine");
              formData.append("jmlBaris", rowCount.toString()); // Jumlah baris asli, bukan panjang lidiSequence
              formData.append("user", username);

              // Menampilkan debug data
              console.log("Mengirim data ke server:");
              console.log("imgAfter:", imagePath);
              console.log("urutanLidi:", lidiString);
              console.log("jmlBaris:", rowCount.toString());

              // Kirim data ke server
              const response = await fetch("/generator/PostImage", {
                method: "POST",
                body: formData,
                headers: {
                  "X-CSRFToken": getCookie("csrftoken"),
                },
              });

              if (response.ok) {
                var successModal = new bootstrap.Modal(
                  document.getElementById("successModal")
                );
                successModal.show();
              } else {
                const errorText = await response.text();
                throw new Error("Gagal menyimpan motif: " + errorText);
              }
            } catch (error) {
              console.error("Error:", error);
              alert("Gagal menyimpan motif: " + error.message);
            }
          }

          // Jalankan proses penggabungan
          combineMotifs();
        }
      </script>
    </div>
  </body>
</html>