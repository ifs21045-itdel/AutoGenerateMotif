<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}" />
    <title>Modul Lidi</title>
    <link
      rel="icon"
      href="{% static 'img/icon/NewTitle.ico' %}"
      type="image/x-icon"
    />
    <style>
      /* Menyesuaikan ukuran gambar motif */
      .motif-size {
        width: 100%;
        height: auto;
        object-fit: contain;
        margin-bottom: 10px; /* Jarak antara gambar */
        position: relative;
      }

      .motif-number {
        position: absolute;
        top: 5px;
        left: 5px;
        background-color: blue;
        color: white;
        font-size: 16px;
        font-weight: bold;
        padding: 5px;
        border-radius: 0px;
        width: 30px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* Styling untuk container Motif */
      .motif-container {
        margin-top: 20px; /* Add space above the container */
        border: 3px solid #000000; /* Increase border width */
        border-radius: 10px; /* Increase border radius for rounder corners */
        padding: 20px; /* Increase padding inside the container */
        background-color: #f5f5f5;
        height: 2250px; /* Increase height */
      }
      /* Styling untuk judul container */
      .motif-container h5 {
        color: rgb(0, 0, 0);
        font-weight: bold;
      }

      .combined-motif-container img {
        width: 100%; /* Ensure the image fills the container width */
        height: auto;
        object-fit: contain;
        margin-bottom: 15px; /* More space between images */
      }

      .combined-motif-container {
        height: 2160px; /* Make it take up full height */
        width: 100%;
        overflow-y: auto;
        padding: 20px; /* Increase padding to give more space */
        background-color: white;
        border: 1px solid #ddd;
        padding-top: 40px; /* Increase top padding */
        align-items: flex-start;
        position: relative;
        margin-top: 20px;
        display: flex; /* Use grid layout */
        grid-template-columns: repeat(
          auto-fill,
          minmax(350px, 1fr)
        ); /* Make sure columns take more space */
        gap: 20px; /* Add more space between images */
        justify-items: center; /* Center the items within the grid cells */
      }

      .combined-motif-container div {
        position: relative;
        width: 100%; /* Make sure the images fill the container */
      }

      /* Card untuk Motif */
      .motif-card {
        margin-bottom: 15px; /* More space between cards */
        border: 2px solid #000000;
        border-radius: 0px;
        padding: 10px;
        background-color: #f9f9f9;
      }

      .main-title {
        font-size: 36px; /* Larger font size for the title */
        text-align: center;
        margin-top: 20px;
        margin-bottom: 30px; /* Add space below the title */
      }

      .motif-container,
      .combined-motif-container {
        width: 100%; /* Make sure all containers take full width */
      }

      /* Menambahkan margin untuk tombol agar lebih ke bawah */
      .btn-container {
        margin-top: 60px; /* More space between buttons */
      }

      .container {
        max-width: 100%; /* Ensure the container takes full width */
        padding-left: 20px; /* Add space to the left */
        padding-right: 20px; /* Add space to the right */
      }

      .card-1 {
        padding: 20px; /* Increase padding inside the card */
        width: 100%; /* Ensure the card takes the full width */
      }

      /* Adjust the column width inside the container */
      .row {
        width: 100%;
      }

      /* Menambahkan garis horizontal merah pada tengah container */
    </style>
  </head>

  <body>
    <div class="container card-0 justify-content-center">
      <div class="card-body px-sm-4 px-0">
        <!-- Judul Utama Modul Lidi -->
        <div class="row justify-content-center mb-5">
          <div class="col-md-10">
            <h3 class="main-title">Modul Lidi</h3>
            <p class="text-center text-white">
              Modul Lidi membantu penenun menghasilkan berbagai motif hanya
              dengan menggunakan sedikit Lidi. Motif yang dihasilkan telah
              teruji mampu menciptakan hingga ratusan motif dengan 8 jenis Lidi.
              Motif ini dapat diterapkan secara pasti pada kain tenun ulos.
            </p>
          </div>
        </div>

        <div class="row justify-content-center round">
          <div class="col-lg-10 col-md-12">
            <div class="card shadow-lg card-1">
              <div class="card-body inner-card">
                <div class="row">
                  <!-- Kolom untuk Menampilkan Motif Asal dan Hasil Motif -->
                  <div class="col-md-6 text-center">
                    <h5 class="motif-title">Motif</h5>
                    <p class="explanation-text">
                      Klik pada motif yang ingin dipilih. Anda dapat memilih
                      lebih dari satu motif untuk digabungkan dalam motif yang
                      sama.
                    </p>
                    <div class="motif-container">
                      <h5>Motif Asal</h5>
                      <div class="card motif-card">
                        <img
                          src="{{ raw_url }}"
                          class="card-img-top motif-size"
                          alt="Motif Asal"
                          onclick="addMotif(this)"
                        />
                      </div>

                      <h5>Hasil Motif 1</h5>
                      <div class="card motif-card">
                        <img
                          src="{{ edit_url }}"
                          class="card-img-top motif-size"
                          alt="Hasil Motif 1"
                          onclick="addMotif(this)"
                        />
                      </div>

                      <h5>Hasil Motif 2</h5>
                      <div class="card motif-card">
                        <img
                          src="{{ edit_url2 }}"
                          class="card-img-top motif-size"
                          alt="Hasil Motif 2"
                          onclick="addMotif(this)"
                        />
                      </div>

                      <h5>Hasil Motif 3</h5>
                      <div class="card motif-card">
                        <img
                          src="{{ edit_url3 }}"
                          class="card-img-top motif-size"
                          alt="Hasil Motif 3"
                          onclick="addMotif(this)"
                        />
                      </div>

                      <h5>Hasil Motif 4</h5>
                      <div class="card motif-card">
                        <img
                          src="{{ edit_url4 }}"
                          class="card-img-top motif-size"
                          alt="Hasil Motif 4"
                          onclick="addMotif(this)"
                        />
                      </div>
                    </div>
                  </div>

                  <!-- Kolom untuk Menampilkan Motif yang Digabungkan -->
                  <div class="col-md-6 text-center">
                    <h5 class="combined-title">Penggabungan Motif</h5>
                    <p class="explanation-text">
                      Jika Anda ingin menghapus motif yang telah dipilih, Anda
                      dapat mengklik motif yang ingin dihapus.
                    </p>
                    <div class="motif-container">
                      <div
                        id="combinedMotifContainer"
                        class="combined-motif-container"
                      >
                        <p class="text-muted">Belum ada motif yang dipilih.</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Tombol Simpan dan Modal -->
                <div class="btn-container row mt-4 text-center">
                  <div class="col-md-12">
                    <button
                      class="btn"
                      onclick="saveMotif()"
                      style="
                        background-color: #002ba3;
                        border: 2px solid #002ba3;
                        border-radius: 0px;
                        padding: 12px 30px 14px;
                        font-size: 1rem;
                        color: #ffffff;
                        display: inline-block;
                        width: 320px;
                      "
                    >
                      Simpan Motif
                    </button>
                  </div>
                </div>

                <div
                  class="modal fade"
                  id="successModal"
                  tabindex="-1"
                  aria-labelledby="exampleModalLabel"
                  aria-hidden="true"
                >
                  <div class="modal-dialog modal-sm">
                    <div class="modal-content" style="border: none">
                      <div
                        class="modal-header d-flex justify-content-center flex-column align-items-center"
                        style="
                          border-bottom: none;
                          position: relative;
                          padding: 0;
                        "
                      >
                        <img
                          src="{% static 'img/icon/checkmark.png' %}"
                          alt="Success"
                          style="width: 140px; margin-bottom: 0"
                        />
                        <div
                          class="modal-body text-center"
                          style="border-bottom: none; padding: 0; margin-top: 0"
                        >
                          Motif Berhasil Dibuat
                        </div>
                      </div>
                      <div
                        class="modal-footer d-flex justify-content-center"
                        style="border-top: none; padding-top: 1"
                      >
                        <button
                          type="button"
                          class="btn btn-primary"
                          onclick="redirectToList()"
                        >
                          Lihat Motif
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Button Back -->
                <div class="btn-container row mt-4 text-center">
                  <div class="col-md-12">
                    <a
                      href="{% url 'generator' %}"
                      class="btn"
                      style="
                        background-color: transparent;
                        border: 2px solid #002ba3;
                        border-radius: 0px;
                        padding: 12px 30px 14px;
                        font-size: 1rem;
                        color: #002ba3;
                        text-decoration: none;
                        display: inline-block;
                        width: 320px;
                      "
                    >
                      Kembali
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

      <script>
        // Fungsi untuk menyimpan motif
        // function saveMotif() {
        //   // Mengirim data motif yang dipilih ke server atau melakukan proses penyimpanan
        //   // Setelah sukses, modal akan muncul
        //   var successModal = new bootstrap.Modal(
        //     document.getElementById("successModal")
        //   );
        //   successModal.show();
        // }

        function redirectToList() {
          window.location.href = "{% url 'list1' %}";
        }

        let motifCounter = 1; // Untuk melacak urutan gambar

        // Fungsi untuk menambahkan motif yang dipilih ke dalam container
        // Fungsi untuk menambahkan motif yang dipilih ke dalam container
        // Fungsi untuk menambahkan motif yang dipilih ke dalam container
        function addMotif(imageElement) {
          var combinedMotifContainer = document.getElementById(
            "combinedMotifContainer"
          );

          // Menghapus pesan "Belum ada motif yang dipilih"
          if (
            combinedMotifContainer.innerHTML.includes(
              "Belum ada motif yang dipilih"
            )
          ) {
            combinedMotifContainer.innerHTML = "";
          }

          // Menghitung jumlah total motif yang sudah ditambahkan
          var totalMotifs = combinedMotifContainer.children.length / 2;

          // Menentukan posisi untuk gambar pertama (di atas)
          var positionOffset = totalMotifs * 100;
          var topPosition = `calc(50% - ${50 + positionOffset + 20}px)`; // Menambah jarak pada posisi atas
          var bottomPosition = `calc(50% + ${50 + positionOffset}px)`; // Posisi bawah tetap

          // Membuat elemen gambar pertama
          var img = document.createElement("img");
          img.src = imageElement.src;
          img.className = "motif-size";
          img.dataset.index = motifCounter;
          img.onclick = function () {
            removeMotif(this);
          };

          // Membuat elemen angka untuk ditampilkan di gambar
          var numberLabel = document.createElement("span");
          numberLabel.className = "motif-number";
          numberLabel.textContent = motifCounter;

          // Membuat elemen container untuk gambar pertama
          var imgContainer = document.createElement("div");
          imgContainer.style.position = "absolute";
          imgContainer.style.left = "50%";
          imgContainer.style.transform = "translateX(-50%)"; // Center the image horizontally
          imgContainer.style.top = topPosition;

          imgContainer.appendChild(img);
          imgContainer.appendChild(numberLabel);

          // Menambahkan gambar pertama ke dalam kontainer penggabungan
          combinedMotifContainer.appendChild(imgContainer);

          // Membuat elemen gambar kedua (untuk gambar kedua)
          var imgDouble = document.createElement("img");
          imgDouble.src = imageElement.src;
          imgDouble.className = "motif-size";
          imgDouble.dataset.index = motifCounter;
          imgDouble.onclick = function () {
            removeMotif(this);
          };

          var numberLabelDouble = document.createElement("span");
          numberLabelDouble.className = "motif-number";
          numberLabelDouble.textContent = motifCounter;

          // Membuat elemen container untuk gambar kedua
          var imgContainerDouble = document.createElement("div");
          imgContainerDouble.style.position = "absolute";
          imgContainerDouble.style.left = "50%";
          imgContainerDouble.style.transform = "translateX(-50%)";
          imgContainerDouble.style.top = bottomPosition;

          imgContainerDouble.appendChild(imgDouble);
          imgContainerDouble.appendChild(numberLabelDouble);

          // Menambahkan gambar kedua ke dalam kontainer penggabungan
          combinedMotifContainer.appendChild(imgContainerDouble);

          motifCounter++;
        }

        function removeMotif(motifElement) {
          // Ambil nilai dataset index dari motif yang diklik
          let indexToRemove = motifElement.dataset.index;
          let motifCounter = 1; // Untuk melacak urutan gambar

          // Fungsi untuk menambahkan motif yang dipilih ke dalam container
          function addMotif(imageElement) {
            var combinedMotifContainer = document.getElementById(
              "combinedMotifContainer"
            );

            // Cek apakah ada pesan "Belum ada motif yang dipilih", jika ada, hapus
            if (
              combinedMotifContainer.innerHTML.includes(
                "Belum ada motif yang dipilih"
              )
            ) {
              combinedMotifContainer.innerHTML = ""; // Hapus pesan tersebut
            }

            // Menghitung jumlah total motif yang sudah ditambahkan
            var totalMotifs = combinedMotifContainer.children.length / 2; // Membagi 2 karena ada 2 gambar per motif (atas dan bawah)

            // Menentukan posisi untuk gambar pertama (gambar yang akan tampil di atas)
            var positionOffset = totalMotifs * 100; // Menghitung offset untuk posisi gambar berdasarkan urutan

            // Posisi gambar pertama di atas
            var topPosition = `calc(50% - ${50 + positionOffset}px)`;
            // Posisi gambar kedua di bawah
            var bottomPosition = `calc(50% + ${50 + positionOffset}px)`;

            // Membuat elemen gambar pertama (untuk gambar baru)
            var img = document.createElement("img");
            img.src = imageElement.src;
            img.className = "motif-size"; // Gambar dengan kelas yang sudah disesuaikan
            img.dataset.index = motifCounter; // Menambahkan atribut untuk urutan gambar
            img.onclick = function () {
              removeMotif(this);
            };

            // Membuat elemen angka untuk ditampilkan di gambar
            var numberLabel = document.createElement("span");
            numberLabel.className = "motif-number";
            numberLabel.textContent = motifCounter; // Menambahkan angka

            // Membuat elemen container untuk gambar pertama dan angka
            var imgContainer = document.createElement("div");
            imgContainer.style.position = "absolute"; // Menggunakan absolute positioning
            imgContainer.style.left = "50%"; // Menempatkan gambar di tengah horizontal
            imgContainer.style.transform = "translateX(-50%)"; // Menjaga agar gambar tetap berada di tengah

            // Menempatkan gambar pertama di bagian atas
            imgContainer.style.top = topPosition;
            imgContainer.appendChild(img);
            imgContainer.appendChild(numberLabel);

            // Menambahkan gambar pertama ke dalam kontainer penggabungan (untuk bagian atas)
            combinedMotifContainer.appendChild(imgContainer);

            // Membuat elemen gambar kedua (untuk gambar baru)
            var imgDouble = document.createElement("img");
            imgDouble.src = imageElement.src;
            imgDouble.className = "motif-size"; // Gambar dengan kelas yang sudah disesuaikan
            imgDouble.dataset.index = motifCounter; // Memberikan angka yang sama
            imgDouble.onclick = function () {
              removeMotif(this);
            };

            var numberLabelDouble = document.createElement("span");
            numberLabelDouble.className = "motif-number";
            numberLabelDouble.textContent = motifCounter; // Menambahkan angka yang sama untuk gambar kedua

            // Membuat elemen container untuk gambar kedua dan angka
            var imgContainerDouble = document.createElement("div");
            imgContainerDouble.style.position = "absolute"; // Menggunakan absolute positioning
            imgContainerDouble.style.left = "50%"; // Menempatkan gambar di tengah horizontal
            imgContainerDouble.style.transform = "translateX(-50%)"; // Menjaga agar gambar tetap berada di tengah

            // Menempatkan gambar kedua di bagian bawah
            imgContainerDouble.style.top = bottomPosition;
            imgContainerDouble.appendChild(imgDouble);
            imgContainerDouble.appendChild(numberLabelDouble);

            // Menambahkan gambar kedua ke dalam kontainer penggabungan (untuk bagian bawah)
            combinedMotifContainer.appendChild(imgContainerDouble);

            motifCounter++; // Menambah urutan gambar hanya 1 kali
          }
          let combinedMotifContainer = document.getElementById(
            "combinedMotifContainer"
          );

          // Ambil seluruh container di dalam combinedMotifContainer
          let motifContainers = Array.from(combinedMotifContainer.children);

          // Hapus semua container yang memiliki gambar dengan dataset index yang sama
          motifContainers.forEach((container) => {
            let img = container.querySelector("img");
            if (img && img.dataset.index === indexToRemove) {
              container.remove();
            }
          });

          // Jika kontainer gabungan sudah kosong, tampilkan notifikasi kembali
          if (combinedMotifContainer.children.length === 0) {
            let notif = document.createElement("p");
            notif.className = "text-muted";
            notif.textContent = "Belum ada motif yang dipilih.";
            combinedMotifContainer.appendChild(notif);
          }
        }
        function saveMotif() {
          // Ambil container motif yang digabungkan
          var combinedMotifContainer = document.getElementById(
            "combinedMotifContainer"
          );

          // Cek apakah ada motif yang dipilih
          if (
            combinedMotifContainer.children.length === 0 ||
            combinedMotifContainer.innerHTML.includes(
              "Belum ada motif yang dipilih"
            )
          ) {
            alert("Pilih motif terlebih dahulu!");
            return;
          }

          // Fungsi untuk memuat gambar
          function loadImage(src) {
            return new Promise((resolve, reject) => {
              var img = new Image();
              img.onload = () => resolve(img);
              img.onerror = reject;
              img.src = src;
            });
          }

          // Proses menggabungkan gambar
          async function combineMotifs() {
            try {
              // Ambil semua kontainer gambar yang berisi gambar
              var motifContainers = Array.from(
                combinedMotifContainer.children
              ).filter((container) => container.querySelector("img"));

              // Kelompokkan gambar berdasarkan posisi (atas/bawah)
              const topImages = [];
              const bottomImages = [];

              motifContainers.forEach((container) => {
                const img = container.querySelector("img");
                // Pisahkan gambar berdasarkan posisi top
                if (container.style.top.includes("-")) {
                  bottomImages.push(img);
                } else {
                  topImages.push(img);
                }
              });

              // Hitung total tinggi yang dibutuhkan
              async function calculateTotalHeight(images, containerWidth) {
                let totalHeight = 0;
                for (let img of images) {
                  const loadedImg = await loadImage(img.src);
                  const scale = containerWidth / loadedImg.width;
                  totalHeight += loadedImg.height * scale + 20; // Tambah sedikit jarak
                }
                return totalHeight;
              }

              // Tentukan lebar canvas
              const canvasWidth = 800; // Lebar tetap

              // Hitung total tinggi gambar
              const topImagesHeight = await calculateTotalHeight(
                topImages,
                canvasWidth
              );
              const bottomImagesHeight = await calculateTotalHeight(
                bottomImages,
                canvasWidth
              );

              // Total tinggi canvas disesuaikan dengan motif
              const canvasHeight = topImagesHeight + bottomImagesHeight + 40; // Tambah sedikit margin

              // Buat canvas dengan ukuran yang tepat
              var canvas = document.createElement("canvas");
              canvas.width = canvasWidth;
              canvas.height = canvasHeight;
              var ctx = canvas.getContext("2d");

              // Warnai background canvas dengan putih
              ctx.fillStyle = "white";
              ctx.fillRect(0, 0, canvas.width, canvas.height);

              // Mulai dari atas
              let yOffset = 20; // Sedikit margin dari atas

              // Fungsi untuk menggambar gambar
              async function drawImages(images, reverse = false) {
                const imagesToDraw = reverse
                  ? images.slice().reverse()
                  : images;

                for (let img of imagesToDraw) {
                  var loadedImg = await loadImage(img.src);

                  // Hitung skala agar gambar muat di canvas
                  var scale = canvas.width / loadedImg.width;
                  var scaledHeight = loadedImg.height * scale;

                  // Gambar di tengah canvas dengan skala persis seperti di grid
                  var xPosition = 0;
                  ctx.drawImage(
                    loadedImg,
                    xPosition,
                    yOffset,
                    canvas.width,
                    scaledHeight
                  );

                  // Geser posisi untuk gambar selanjutnya sesuai posisi di grid
                  yOffset += scaledHeight + 20; // Tambah sedikit jarak antar gambar
                }
              }

              // Gambar bagian atas
              await drawImages(topImages);

              // Gambar bagian bawah dalam urutan terbalik
              await drawImages(bottomImages, true);

              // Buat link download
              var link = document.createElement("a");
              link.download = "motif_gabungan.png";
              link.href = canvas.toDataURL("image/png");
              link.click();

              // Tampilkan modal sukses
              var successModal = new bootstrap.Modal(
                document.getElementById("successModal")
              );
              successModal.show();
            } catch (error) {
              console.error("Gagal menggabungkan motif:", error);
              alert("Gagal mendownload motif. Silakan coba lagi.");
            }
          }

          // Jalankan proses penggabungan
          combineMotifs();
        }

      </script>
    </div>
  </body>
</html>
