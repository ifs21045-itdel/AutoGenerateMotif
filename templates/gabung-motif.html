<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}" />
    <link rel="stylesheet" href="{% static 'templatemo-style.css' %}" />
    <title>Modul Lidi</title>
    <link
      rel="icon"
      href="{% static 'img/icon/NewTitle.ico' %}"
      type="image/x-icon"
    />
    <link
      rel="icon"
      href="{% static 'img/icon/NewTitle.png' %}"
      type="image/x-icon"
    />
    <style>
      h1, h2, h3, h4, h5, h6 { margin: 0; padding: 0; }
      .main-title { font-size: 36px; text-align: center; margin-top: 10px; margin-bottom: 0; }
      h1 { font-size: 36px; text-align: center; margin-top: 10px; margin-bottom: 0; }
      h2 { font-size: 30px; text-align: center; margin-top: 10px; margin-bottom: 0; }
      h3 { font-size: 24px; text-align: center; margin-top: 10px; margin-bottom: 0; }
      .container { max-width: 75%; padding-left: 20px; padding-right: 20px; margin-top: 31px; }
      .form-container { display: flex; justify-content: space-between; gap: 15px; margin-top: -83px; margin-bottom: 30px; }
      .form-container div { flex: 1; }
      .form-container h5.combined-title { font-size: 10px; color: #000000; text-align: center; }
      .form-container p { font-size: 15px; color: rgb(122, 121, 121); text-align: center; }
      .motif-container { margin-top: 0; border: 3px solid #000000; border-radius: 10px; padding: 15px; background-color: #f5f5f5; height: 1250px; }
      .motif-container h5 { color: rgb(0, 0, 0); font-weight: bold; margin-top: 0; }
      .new-combined-motif-container { margin-top: 20px; padding: 15px; background-color: white; border: 1px solid #ddd; align-items: center; position: relative; display: flex; flex-direction: column; gap: 15px; justify-items: center; height: auto; width: 100%; overflow-y: auto; }
      .motif-size { width: 100%; height: auto; object-fit: contain; margin-bottom: 10px; position: relative; }
      .motif-number { position: absolute; top: 5px; left: 5px; background-color: blue; color: white; font-size: 16px; font-weight: bold; padding: 5px; border-radius: 0px; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; }
      .new-combined-motif-container div { position: relative; width: 100%; }
      .motif-card { margin-bottom: 10px; border: 2px solid #000000; border-radius: 0px; padding: 10px; background-color: #f9f9f9; }
      .btn-container { margin-top: 40px; display: flex; justify-content: center; align-items: center; }
      .motif-item { display: flex; flex-direction: column; gap: 15px; position: relative; cursor: pointer; align-items: center; }
      .inner-card > .row { display: flex; align-items: flex-start; justify-content: center; }
      .inner-card > .row > .col-md-6 { display: flex; flex-direction: column; align-items: center; }
      .card-1 { padding: 15px; width: 100%; display: flex; justify-content: center; align-items: center; }
      .row { width: 100%; display: flex; justify-content: center; align-items: center; }
      .motif-pair-container { display: flex; flex-direction: column; gap: 15px; position: relative; width: 100%; max-width: 500px; margin: 0 auto; margin-bottom: 60px; }
      .motif-pair { position: relative; width: 100%; display: flex; justify-content: center; align-items: center; }
      .motif-pair img { width: 100%; height: auto; object-fit: contain; border: 1px solid #ddd; display: block; margin: 0 auto; }
      .equal-height-row { display: flex; align-items: stretch; justify-content: center; }
      .equal-height-col { display: flex; flex-direction: column; align-items: center; }
      .select-wrapper { position: relative; display: block; margin: 0 auto; width: 200px; }
      .select-wrapper select { appearance: none; padding-right: 20px; font-size: 14px; color: #000000; width: 100%; text-align: center; box-sizing: border-box; }
      .select-wrapper::after { content: "▼"; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); pointer-events: none; font-size: 15px; color: #000000; }
    </style>
  </head>
  <body>
    {% include "header.html" %}
    <div id="loader-wrapper">
      <div id="loader"></div>
      <div class="loader-section section-left"></div>
      <div class="loader-section section-right"></div>
    </div>
    <div class="container card-0 justify-content-center">
      <div class="card-body px-sm-4 px-0">
        <!-- Judul Utama Modul Lidi -->
        <div class="row justify-content-center mb-5">
          <div class="col-md-10">
            <h3 class="main-title">Modul Lidi</h3>
            <p class="text-center text-white">
              Modul Lidi membantu penenun menghasilkan berbagai motif hanya
              dengan menggunakan sedikit Lidi. Motif yang dihasilkan telah
              teruji mampu menciptakan hingga ratusan motif dengan 8 jenis Lidi.
              Motif ini dapat diterapkan secara pasti pada kain tenun ulos.
            </p>
          </div>
        </div>

        <div class="row justify-content-center round">
          <div class="col-lg-10 col-md-12">
            <div class="card shadow-lg card-1">
              <div class="card-body inner-card">
                <div class="row equal-height-row">
                  <div class="form-container">
                    <div>
                      <h3>Jenis Kain</h3>
                      <p>Klik untuk memilih</p>
                      <div class="select-wrapper">
                        <select name="jenis_kain" id="jenis_kain">
                          <option value="harungguan">Harungguan</option>
                          <option value="sadum">Sadum</option>
                          <option value="puca">Puca</option>
                        </select>
                      </div>
                    </div>

                    <div>
                      <h3>Jenis Produk</h3>
                      <p>Klik untuk memilih</p>
                      <div class="select-wrapper">
                        <select name="jenis_produk" id="jenis_produk">
                          <option value="songket">Songket</option>
                          <option value="selendang">Selendang</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <!-- Kolom untuk Menampilkan Motif Asal dan Hasil Motif -->
                  <div class="col-md-6 equal-height-col">
                    <h5 class="motif-title text-center">Motif</h5>
                    <p class="explanation-text text-center">
                      Silakan pilih motif yang Anda inginkan. Anda bisa memilih
                      lebih dari satu motif untuk digabungkan.
                    </p>

                    <div class="motif-container">
                      <br />
                      <h5 class="text-center">Motif Asal</h5>
                      <p class="text-center">Urutan Asal: {{ urutanasal }}</p>
                      <div class="card motif-card">
                        <img
                          src="{{ raw_url }}"
                          class="card-img-top motif-size"
                          alt="Motif Asal"
                          loading="lazy"
                          data-jenis="asal"
                          data-urutanasal="{{ urutanasal }}"
                          data-mirror="true"
                          onclick="addMotif(this)"
                        />
                      </div>

                      <h5 class="text-center">Hasil Motif 1</h5>
                      <div class="card motif-card">
                        <img
                          src="{{ edit_url }}"
                          class="card-img-top motif-size"
                          alt="Hasil Motif 1"
                          loading="lazy"
                          data-urutanasal="{{ urutan }}"
                          data-mirror="true"
                          onclick="addMotif(this)"
                        />
                      </div>

                      <h5 class="text-center">Hasil Motif 2</h5>
                      <div class="card motif-card">
                        <img
                          src="{{ edit_url2 }}"
                          class="card-img-top motif-size"
                          alt="Hasil Motif 2"
                          loading="lazy"
                          data-urutanasal="{{ urutan1 }}"
                          data-mirror="true"
                          onclick="addMotif(this)"
                        />
                      </div>

                      <h5 class="text-center">Hasil Motif 3</h5>
                      <div class="card motif-card">
                        <img
                          src="{{ edit_url3 }}"
                          class="card-img-top motif-size"
                          alt="Hasil Motif 3"
                          loading="lazy"
                          data-urutanasal="{{ urutan2 }}"
                          data-mirror="true"
                          onclick="addMotif(this)"
                        />
                      </div>

                      <h5 class="text-center">Hasil Motif 4</h5>
                      <div class="card motif-card">
                        <img
                          src="{{ edit_url4 }}"
                          class="card-img-top motif-size"
                          alt="Hasil Motif 4"
                          loading="lazy"
                          data-urutanasal="{{ urutan3 }}"
                          data-mirror="true"
                          onclick="addMotif(this)"
                        />
                      </div>
                    </div>
                  </div>

                  <!-- Kolom untuk Menampilkan Motif yang Digabungkan -->
                  <div class="col-md-6 equal-height-col">
                    <h5 class="combined-title text-center">
                      Penggabungan Motif
                    </h5>
                    <p class="explanation-text text-center">
                      Untuk menghapus motif yang sudah dipilih, silakan pilih
                      motif yang ingin dihapus.
                    </p>
                    <div class="motif-container">
                      <div
                        id="newCombinedMotifContainer"
                        class="new-combined-motif-container"
                      >
                        <p class="text-muted">Belum ada motif yang dipilih.</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Tombol Simpan dan Modal -->
                <div class="btn-container row mt-4 text-center">
                  <div class="col-md-12">
                    <button
                      class="btn"
                      onclick="saveMotif()"
                      style="
                        background-color: #002ba3;
                        border: 2px solid #002ba3;
                        border-radius: 0px;
                        padding: 12px 30px 14px;
                        font-size: 1rem;
                        color: #ffffff;
                        display: inline-block;
                        width: 320px;
                      "
                    >
                      Simpan Motif
                    </button>
                  </div>
                </div>

                <div
                  class="modal fade"
                  id="successModal"
                  tabindex="-1"
                  aria-labelledby="exampleModalLabel"
                  aria-hidden="true"
                >
                  <div class="modal-dialog modal-sm">
                    <div class="modal-content" style="border: none">
                      <div
                        class="modal-header d-flex justify-content-center flex-column align-items-center"
                        style="
                          border-bottom: none;
                          position: relative;
                          padding: 0;
                        "
                      >
                        <img
                          src="{% static 'img/icon/checkmark.png' %}"
                          alt="Success"
                          style="width: 140px; margin-bottom: 0"
                        />
                        <div
                          class="modal-body text-center"
                          style="border-bottom: none; padding: 0; margin-top: 0"
                        >
                          Motif Berhasil Dibuat
                        </div>
                      </div>
                      <div
                        class="modal-footer d-flex justify-content-center"
                        style="border-top: none; padding-top: 1"
                      >
                        <button
                          type="button"
                          class="btn btn-primary"
                          onclick="redirectToList()"
                        >
                          Lihat Motif
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Modal Error -->
                <div
                  class="modal fade"
                  id="errorModal"
                  tabindex="-1"
                  aria-hidden="true"
                >
                  <div class="modal-dialog modal-sm">
                    <div class="modal-content" style="border: none">
                      <div
                        class="modal-header d-flex justify-content-center flex-column align-items-center"
                        style="
                          border-bottom: none;
                          position: relative;
                          padding: 0;
                        "
                      >
                        <div
                          class="modal-body text-center"
                          style="border-bottom: none; padding: 0; margin-top: 0"
                        >
                          <div style="font-size: 64px; color: red">❌</div>
                          <span id="errorModalMessage"
                            >Pilih motif terlebih dahulu!</span
                          >
                        </div>
                      </div>
                      <div
                        class="modal-footer d-flex justify-content-center"
                        style="border-top: none"
                      >
                        <button
                          type="button"
                          data-bs-dismiss="modal"
                          class="btn"
                          style="
                            background-color: #002ba3;
                            border: 2px solid #002ba3;
                            border-radius: 0px;
                            padding: 12px 30px 14px;
                            font-size: 1rem;
                            color: #ffffff;
                            display: inline-block;
                            width: 320px;
                          "
                        >
                          OK
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Button Back -->
                <div class="btn-container row mt-4 text-center">
                  <div class="col-md-12">
                    <a
                      href="{% url 'generator' %}"
                      class="btn"
                      style="
                        background-color: transparent;
                        border: 2px solid #002ba3;
                        border-radius: 0px;
                        padding: 12px 30px 14px;
                        font-size: 1rem;
                        color: #002ba3;
                        text-decoration: none;
                        display: inline-block;
                        width: 320px;
                      "
                    >
                      Kembali
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% include "footer.html" %}
    <!-- Tambahkan jQuery secara eksplisit -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
    <script src="{% static 'plugins.js' %}" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" defer
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"></script>
    <script src="{% static 'script.js' %}" defer></script>
    <script>
      // Gunakan vanilla JavaScript sebagai pengganti jQuery
      window.addEventListener("load", function () {
        document.body.classList.add("loaded");
      });

      // Cache elemen DOM
      const combinedMotifContainer = document.getElementById("newCombinedMotifContainer");
      const jenisKainSelect = document.getElementById('jenis_kain');
      const jenisProdukSelect = document.getElementById('jenis_produk');

      // Fungsi untuk mengatur ukuran container berdasarkan pilihan
      function adjustCombinedMotifContainer() {
        if (jenisProdukSelect) {
          const selectedValue = jenisProdukSelect.value;
          if (selectedValue === 'songket') {
            combinedMotifContainer.style.maxWidth = '500px';
            combinedMotifContainer.style.maxHeight = '800px';
          } else if (selectedValue === 'selendang') {
            combinedMotifContainer.style.maxWidth = '300px';
            combinedMotifContainer.style.maxHeight = '600px';
          }
        }
      }

      // Tambahkan event listener untuk mendeteksi perubahan pada select
      document.addEventListener('DOMContentLoaded', function() {
        if (jenisKainSelect && jenisProdukSelect) {
          adjustCombinedMotifContainer(); // Panggil saat halaman dimuat untuk set awal
          jenisKainSelect.addEventListener('change', renderMotifs);
          jenisProdukSelect.addEventListener('change', adjustCombinedMotifContainer);
          jenisProdukSelect.addEventListener('change', renderMotifs);
        }
      });

      let allMotifImages = [];
      let urutanAsalArray = [];
      let urutanGabunganArray = [];

      function redirectToList() {
        if (window.savedMotifId) {
          window.location.href = `/list/${window.savedMotifId}`;
        } else {
          console.error("Motif ID tidak tersedia.");
          window.location.href = "{% url 'list1' %}"; // Fallback ke halaman daftar motif
        }
      }

      function updateMotifNumbers() {
        const labels = combinedMotifContainer.querySelectorAll(".motif-number");
        const totalMotifs = allMotifImages.length;

        for (let i = 0; i < totalMotifs; i++) {
          labels[i].textContent = totalMotifs - i;
        }

        for (let i = totalMotifs; i < labels.length; i++) {
          labels[i].textContent = i - totalMotifs + 1;
        }
      }

      function renderMotifs() {
        requestAnimationFrame(() => {
          combinedMotifContainer.innerHTML = "";

          if (allMotifImages.length === 0) {
            const notif = document.createElement("p");
            notif.className = "text-muted";
            notif.textContent = "Belum ada motif yang dipilih.";
            combinedMotifContainer.appendChild(notif);
            return;
          }

          const jenisKain = jenisKainSelect.value;
          const jenisProduk = jenisProdukSelect.value;

          const motifPair = document.createElement("div");
          motifPair.className = "motif-pair";
          motifPair.style.display = "flex";
          motifPair.style.flexDirection = "column";
          motifPair.style.alignItems = "center";

          function createMotifImage(src, index, isMirror = false, position = 'body') {
            const wrapper = document.createElement("div");
            wrapper.style.marginBottom = "20px";
            wrapper.style.textAlign = "center";
            wrapper.style.position = "relative";

            const label = document.createElement("span");
            label.className = "motif-number";
            label.textContent = index + 1;
            label.style.position = "absolute";
            label.style.top = "5px";
            label.style.left = "5px";
            label.style.backgroundColor = "blue";
            label.style.color = "white";
            label.style.padding = "2px 6px";
            label.style.fontWeight = "bold";
            label.style.fontSize = "12px";
            label.style.zIndex = "1";

            const img = document.createElement("img");
            img.src = src === "motif kosong" ? "https://via.placeholder.com/150?text=Kosong" : src;
            img.className = "motif-size";
            img.style.maxWidth = "100%";
            if (isMirror) img.style.transform = "scaleY(-1)";
            img.dataset.index = index;
            img.dataset.position = position;

            img.setAttribute("data-urutanasal", JSON.stringify(urutanAsalArray[index] || []));
            img.setAttribute("data-mirror", isMirror ? "true" : "false");

            img.onclick = function () {
              removeMotif(index);
            };

            wrapper.appendChild(img);
            wrapper.appendChild(label);
            return wrapper;
          }

          // Logika penempatan motif berdasarkan jenis kain dan produk
          if (jenisKain === 'harungguan') {
            if (jenisProduk === 'songket' || jenisProduk === 'selendang') {
              const totalMotifs = allMotifImages.length;

              // Susunan vertikal dari atas ke bawah
              for (let i = 0; i < totalMotifs; i++) {
                if (allMotifImages[i] !== "motif kosong") {
                  motifPair.appendChild(createMotifImage(allMotifImages[i], i, false, 'body'));
                }
              }
            }
          } else if (jenisKain === 'puca') {
            if (jenisProduk === 'songket' || jenisProduk === 'selendang') {
              const totalMotifs = allMotifImages.length;
              if (totalMotifs % 2 === 0) {
                alert("Jumlah motif harus ganjil untuk Puca!");
                return;
              }
              const middleIndex = Math.floor(totalMotifs / 2);

              // Bagian atas (sebelum tengah)
              for (let i = 0; i < middleIndex; i++) {
                if (allMotifImages[i] !== "motif kosong") {
                  motifPair.appendChild(createMotifImage(allMotifImages[i], i, false, 'top'));
                }
              }

              // Motif pembatas tengah
              if (allMotifImages[middleIndex] !== "motif kosong") {
                const dividerWrapper = document.createElement("div");
                dividerWrapper.style.marginBottom = "20px";
                dividerWrapper.style.textAlign = "center";
                const dividerImg = document.createElement("img");
                dividerImg.src = "https://via.placeholder.com/150?text=Pembatas";
                dividerImg.className = "motif-size";
                dividerImg.style.maxWidth = "100%";
                dividerWrapper.appendChild(dividerImg);
                motifPair.appendChild(dividerWrapper);
              }

              // Bagian bawah (cermin dari atas)
              for (let i = totalMotifs - 1; i > middleIndex; i--) {
                if (allMotifImages[i] !== "motif kosong") {
                  motifPair.appendChild(createMotifImage(allMotifImages[i], i, true, 'bottom'));
                }
              }
            }
          } else if (jenisKain === 'sadum') {
            if (jenisProduk === 'songket' || jenisProduk === 'selendang') {
              const totalMotifs = allMotifImages.length;
              const halfCount = Math.floor(totalMotifs / 2);

              // Bagian atas (normal)
              for (let i = 0; i < halfCount; i++) {
                if (allMotifImages[i] !== "motif kosong") {
                  motifPair.appendChild(createMotifImage(allMotifImages[i], i, false, 'top'));
                }
              }

              // Bagian bawah (cermin dari atas)
              for (let i = halfCount - 1; i >= 0; i--) {
                if (allMotifImages[i] !== "motif kosong") {
                  motifPair.appendChild(createMotifImage(allMotifImages[i], i, true, 'bottom'));
                }
              }
            }
          }

          combinedMotifContainer.appendChild(motifPair);
          updateMotifNumbers();
          tampilkanUrutanGabungan();
        });
      }

      function addMotif(imageElement) {
        const urutanArray = JSON.parse(imageElement.getAttribute("data-urutanasal"));
        const src = imageElement.src;
        const jumlahAktif = allMotifImages.filter(
          (item) => item !== "motif kosong"
        ).length;
        if (jumlahAktif >= 11) {
          alert("Motif yang ditambahkan maksimal 11!");
          return;
        }
        const kosongIndex = allMotifImages.findIndex(
          (item) => item === "motif kosong"
        );
        if (kosongIndex !== -1) {
          allMotifImages[kosongIndex] = src;
          urutanAsalArray[kosongIndex] = urutanArray;
        } else {
          allMotifImages.push(src);
          urutanAsalArray.push(urutanArray);
        }

        tampilkanUrutanGabungan();
        renderMotifs();
      }

      function removeMotif(indexToRemove) {
        if (
          indexToRemove >= 0 &&
          indexToRemove < allMotifImages.length &&
          indexToRemove < urutanAsalArray.length
        ) {
          if (allMotifImages[indexToRemove] === "motif kosong") {
            allMotifImages.splice(indexToRemove, 1);
            urutanAsalArray.splice(indexToRemove, 1);
          } else {
            allMotifImages[indexToRemove] = "motif kosong";
            urutanAsalArray[indexToRemove] = [];
          }

          renderMotifs();
          tampilkanUrutanGabungan();
        }
      }

      function tampilkanUrutanGabungan() {
        const jenisKain = jenisKainSelect.value;
        const jenisProduk = jenisProdukSelect.value;
        let normal = [];
        let mirror = [];

        if (jenisKain === 'harungguan') {
          if (jenisProduk === 'songket' || jenisProduk === 'selendang') {
            normal = urutanAsalArray.flat();
          }
        } else if (jenisKain === 'puca') {
          if (jenisProduk === 'songket' || jenisProduk === 'selendang') {
            const totalMotifs = urutanAsalArray.length;
            const middleIndex = Math.floor(totalMotifs / 2);
            normal = urutanAsalArray.slice(0, middleIndex).flat()
                   .concat(urutanAsalArray.slice(middleIndex + 1).flat());
            mirror = urutanAsalArray.slice(middleIndex + 1).reverse().map((arr) => [...arr].reverse()).flat();
          }
        } else if (jenisKain === 'sadum') {
          if (jenisProduk === 'songket' || jenisProduk === 'selendang') {
            const totalMotifs = urutanAsalArray.length;
            const halfCount = Math.floor(totalMotifs / 2);
            normal = urutanAsalArray.slice(0, halfCount).flat();
            mirror = urutanAsalArray.slice(0, halfCount).reverse().map((arr) => [...arr].reverse()).flat();
          }
        }

        const gabungan = normal.concat(mirror);
        urutanGabunganArray = gabungan;
        console.log("Gabungan urutan:", gabungan);

        const el = document.getElementById("urutanGabungan");
        if (el) el.textContent = `Gabungan urutan: [${gabungan.join(", ")}]`;
      }

      function saveMotif() {
        const combinedMotifContainer = document.getElementById("newCombinedMotifContainer");

        if (
          combinedMotifContainer.children.length === 0 ||
          combinedMotifContainer.innerHTML.includes("Belum ada motif yang dipilih")
        ) {
          const errorModal = new bootstrap.Modal(document.getElementById("errorModal"));
          const errorModalMessage = document.getElementById("errorModalMessage");
          if (errorModalMessage) {
            errorModalMessage.textContent = "Pilih motif terlebih dahulu!";
            errorModal.show();
          } else {
            console.error("Error: Element with ID 'errorModalMessage' not found.");
          }
          return;
        }

        function loadImage(src) {
          return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = src;
          });
        }

        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === name + "=") {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }

        async function combineMotifs() {
          try {
            const motifImages = Array.from(combinedMotifContainer.querySelectorAll("img"));
            if (motifImages.length === 0) {
              alert("Tidak ada gambar ditemukan.");
              return;
            }

            const canvasWidth = parseInt(combinedMotifContainer.style.maxWidth) || 500;
            let totalHeight = 0;
            const loadedImages = [];

            // Optimasi: Batasi resolusi untuk performa lebih baik
            const maxResolution = 300; // Resolusi maksimum dalam piksel
            for (let img of motifImages) {
              const loaded = await loadImage(img.src);
              const scale = Math.min(maxResolution / loaded.width, 1);
              const scaledHeight = loaded.height * scale;
              loadedImages.push({ image: loaded, height: scaledHeight });
              totalHeight += scaledHeight;
            }

            const canvas = document.createElement("canvas");
            canvas.width = canvasWidth;
            canvas.height = totalHeight;
            const ctx = canvas.getContext("2d");
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, totalHeight);
            let yOffset = 0;
            for (let { image, height } of loadedImages) {
              const scale = canvasWidth / image.width;
              ctx.drawImage(image, 0, yOffset, canvasWidth, height);
              yOffset += height;
            }
            const jumlahAsal = "{{ jumlahasal }}";

            const dataURL = canvas.toDataURL("image/png");
            const blob = await (await fetch(dataURL)).blob();
            const imgAsal = document.querySelector('img[data-jenis="asal"]');
            const imgBeforeSrc = imgAsal ? imgAsal.src : "";
            const formDataUpload = new FormData();
            formDataUpload.append("file", blob, "motif_gabung.png");
            formDataUpload.append("imgBefore", imgBeforeSrc);
            formDataUpload.append("imgAfter", "/media/uploads/itha.png");
            formDataUpload.append("urutanLidi", urutanGabunganArray.join(","));
            formDataUpload.append("jenisGenerate", "otomatis");
            formDataUpload.append("user", "itha");
            formDataUpload.append("csrfmiddlewaretoken", getCookie("csrftoken"));
            formDataUpload.append("jmlBaris", urutanGabunganArray.join(","));

            const response = await fetch("/generator/PostImageGabungan", {
              method: "POST",
              body: formDataUpload,
              headers: {
                "X-CSRFToken": getCookie("csrftoken"),
              },
            });

            if (response.ok) {
              const responseData = await response.json();
              const motifId = responseData.motif_id;
              const successModal = new bootstrap.Modal(document.getElementById("successModal"));
              successModal.show();
              window.savedMotifId = motifId;
            } else {
              const errorText = await response.text();
              throw new Error("Gagal menyimpan motif: " + errorText);
            }
          } catch (error) {
            console.error("Error:", error);
            alert("Gagal menyimpan motif: " + error.message);
          }
        }
        combineMotifs();
      }
    </script>
  </body>
</html>