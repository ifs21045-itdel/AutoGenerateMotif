<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}" />
    <link rel="stylesheet" href="{% static 'templatemo-style.css' %}" />
    <title>Modul Lidi</title>
    <link
      rel="icon"
      href="{% static 'img/icon/NewTitle.ico' %}"
      type="image/x-icon"
    />
    <link
      rel="icon"
      href="{% static 'img/icon/NewTitle.png' %}"
      type="image/x-icon"
    />
    <style>
      /* Menyesuaikan ukuran gambar motif */
      .motif-size {
        width: 100%;
        height: auto;
        object-fit: contain;
        margin-bottom: 10px; /* Jarak antara gambar */
        position: relative;
      }

      .motif-number {
        position: absolute;
        top: 5px;
        left: 5px;
        background-color: blue;
        color: white;
        font-size: 16px;
        font-weight: bold;
        padding: 5px;
        border-radius: 0px;
        width: 30px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* Styling untuk container Motif */
      .motif-container {
        margin-top: 20px; /* Add space above the container */
        border: 3px solid #000000; /* Increase border width */
        border-radius: 10px; /* Increase border radius for rounder corners */
        padding: 20px; /* Increase padding inside the container */
        background-color: #f5f5f5;
        flex: 1;
      }
      /* Styling untuk judul container */
      .motif-container h5 {
        color: rgb(0, 0, 0);
        font-weight: bold;
      }

      .motif-container,
    .combined-motif-container {
      margin-top: 0;
      padding-top: 0;
    }
      .mirror-line {
        /* Garis merah pembatas cermin */
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 2px;
        background-color: red;
        z-index: 1;
      }

      .combined-motif-container {
        height: auto;
        width: 100%;
        overflow-y: auto;
        padding: 20px; /* Increase padding to give more space */
        background-color: white;
        border: 1px solid #ddd;
        padding-top: 40px; /* Increase top padding */
        align-items: center;
        max-height: 100%;
        position: relative;
        margin-top: 45px !important;
        display: flex; /* Use grid layout */
        flex-direction: column;
        grid-template-columns: 1fr;
        grid-auto-rows: minmax(150px, auto);
        /* Make sure columns take more space */
        gap: 20px; /* Add more space between images */
        justify-items: center; /* Center the items within the grid cells */
        flex: 1;
      }

      .combined-motif-container div {
        position: relative;
        width: 100%; /* Make sure the images fill the container */
      }

      /* Card untuk Motif */
      .motif-card {
        margin-bottom: 15px; /* More space between cards */
        border: 2px solid #000000;
        border-radius: 0px;
        padding: 10px;
        background-color: #f9f9f9;
      }

      .main-title {
        font-size: 36px; /* Larger font size for the title */
        text-align: center;
        margin-top: 20px;
        margin-bottom: 30px; /* Add space below the title */
      }

      .motif-container,
      .combined-motif-container {
        width: 100%; /* Make sure all containers take full width */
      }

      /* Menambahkan margin untuk tombol agar lebih ke bawah */
      .btn-container {
        margin-top: 60px; /* More space between buttons */
      }

      .motif-item {
        display: flex;
        flex-direction: column;
        gap: 20px; /* Jarak antara gambar atas dan bawah */
        position: relative;
        cursor: pointer;
      }

      .container {
        max-width: 100%; /* Ensure the container takes full width */
        padding-left: 20px; /* Add space to the left */
        padding-right: 20px; /* Add space to the right */
      }

      /* Menyamakan tinggi kedua kolom */
      .inner-card > .row {
        display: flex;
        align-items: flex-start;
      }


      .inner-card > .row > .col-md-6 {
        display: flex;
        flex-direction: column;
      }



      .card-1 {
        padding: 20px; /* Increase padding inside the card */
        width: 100%; /* Ensure the card takes the full width */
      }

      /* Adjust the column width inside the container */
      .row {
        width: 100%;
      }

      .motif-pair-container {
        display: flex;
        flex-direction: column;
        gap: 20px; /* Jarak antara gambar atas dan bawah */
        position: relative;
        width: 100%;
        max-width: 500px;
        margin-bottom: 80px;
      }

      .motif-pair {
        position: relative;
        width: 100%;
      }

      .motif-pair img {
        width: 100%;
        height: auto;
        object-fit: contain;
        border: 1px solid #ddd;
      }
    </style>
  </head>
  <body>
    {% include "header.html" %}
    <div id="loader-wrapper">
      <div id="loader"></div>
      <div class="loader-section section-left"></div>
      <div class="loader-section section-right"></div>
    </div>
    <div class="container card-0 justify-content-center">
      <div class="card-body px-sm-4 px-0">
        <!-- Judul Utama Modul Lidi -->
        <div class="row justify-content-center mb-5">
          <div class="col-md-10">
            <h3 class="main-title">Modul Lidi</h3>
            <p class="text-center text-white">
              Modul Lidi membantu penenun menghasilkan berbagai motif hanya
              dengan menggunakan sedikit Lidi. Motif yang dihasilkan telah
              teruji mampu menciptakan hingga ratusan motif dengan 8 jenis Lidi.
              Motif ini dapat diterapkan secara pasti pada kain tenun ulos.
            </p>
          </div>
        </div>

        <div class="row justify-content-center round">
          <div class="col-lg-10 col-md-12">
            <div class="card shadow-lg card-1">
              <div class="card-body inner-card">
                <div class="row">
                  <!-- Kolom untuk Menampilkan Motif Asal dan Hasil Motif -->
                  <div class="col-md-6 text-center">
                    <h5 class="motif-title">Motif</h5>
                    <p class="explanation-text">
                      Silakan pilih motif yang Anda inginkan. Anda bisa memilih lebih dari satu motif untuk digabungkan.
                    </p>

                    <div class="motif-container">
                      <h5>Motif Asal</h5>
                      <p>Urutan Asal: {{ urutanasal }}</p>
                      <div class="card motif-card">
                        <img
                          src="{{ raw_url }}"
                          class="card-img-top motif-size"
                          alt="Motif Asal"
                          data-jenis="asal"
                          data-urutanasal="{{ urutanasal }}"
                          data-mirror="true"
                          onclick="addMotif(this)"
                        />
                      </div>

                      <h5>Hasil Motif 1</h5>
                      <div class="card motif-card">
                        <img
                          src="{{ edit_url }}"
                          class="card-img-top motif-size"
                          alt="Hasil Motif 1"
                          data-urutanasal="{{ urutan }}"
                          data-mirror="true"
                          onclick="addMotif(this)"
                        />
                      </div>

                      <h5>Hasil Motif 2</h5>
                      <div class="card motif-card">
                        <img
                          src="{{ edit_url2 }}"
                          class="card-img-top motif-size"
                          alt="Hasil Motif 2"
                          data-urutanasal="{{ urutan1 }}"
                          data-mirror="true"
                          onclick="addMotif(this)"
                        />
                      </div>

                      <h5>Hasil Motif 3</h5>
                      <div class="card motif-card">
                        <img
                          src="{{ edit_url3 }}"
                          class="card-img-top motif-size"
                          alt="Hasil Motif 3"
                          data-urutanasal="{{ urutan2 }}"
                          data-mirror="true"
                          onclick="addMotif(this)"
                        />
                      </div>

                      <h5>Hasil Motif 4</h5>
                      <div class="card motif-card">
                        <img
                          src="{{ edit_url4 }}"
                          class="card-img-top motif-size"
                          alt="Hasil Motif 4"
                          data-urutanasal="{{ urutan3 }}"
                          data-mirror="true"
                          onclick="addMotif(this)"
                        />
                      </div>
                    </div>
                  </div>

                  <!-- Kolom untuk Menampilkan Motif yang Digabungkan -->
                  <div class="col-md-6 text-center">
                    <h5 class="combined-title">Penggabungan Motif</h5>
                    <p class="explanation-text">
                      Untuk menghapus motif yang sudah dipilih, silakan pilih motif yang ingin dihapus.
                    </p>
                    <div class="motif-container">
                      <div
                        id="combinedMotifContainer"
                        class="combined-motif-container"
                      >
                        <p class="text-muted">Belum ada motif yang dipilih.</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Tombol Simpan dan Modal -->
                <div class="btn-container row mt-4 text-center">
                  <div class="col-md-12">
                    <button
                      class="btn"
                      onclick="saveMotif()"
                      style="
                        background-color: #002ba3;
                        border: 2px solid #002ba3;
                        border-radius: 0px;
                        padding: 12px 30px 14px;
                        font-size: 1rem;
                        color: #ffffff;
                        display: inline-block;
                        width: 320px;
                      "
                    >
                      Simpan Motif
                    </button>
                  </div>
                </div>

                <div
                  class="modal fade"
                  id="successModal"
                  tabindex="-1"
                  aria-labelledby="exampleModalLabel"
                  aria-hidden="true"
                >
                  <div class="modal-dialog modal-sm">
                    <div class="modal-content" style="border: none">
                      <div
                        class="modal-header d-flex justify-content-center flex-column align-items-center"
                        style="
                          border-bottom: none;
                          position: relative;
                          padding: 0;
                        "
                      >
                        <img
                          src="{% static 'img/icon/checkmark.png' %}"
                          alt="Success"
                          style="width: 140px; margin-bottom: 0"
                        />
                        <div
                          class="modal-body text-center"
                          style="border-bottom: none; padding: 0; margin-top: 0"
                        >
                          Motif Berhasil Dibuat
                        </div>
                      </div>
                      <div
                        class="modal-footer d-flex justify-content-center"
                        style="border-top: none; padding-top: 1"
                      >
                        <button
                          type="button"
                          class="btn btn-primary"
                          onclick="redirectToList()"
                        >
                          Lihat Motif
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Button Back -->
                <div class="btn-container row mt-4 text-center">
                  <div class="col-md-12">
                    <a
                      href="{% url 'generator' %}"
                      class="btn"
                      style="
                        background-color: transparent;
                        border: 2px solid #002ba3;
                        border-radius: 0px;
                        padding: 12px 30px 14px;
                        font-size: 1rem;
                        color: #002ba3;
                        text-decoration: none;
                        display: inline-block;
                        width: 320px;
                      "
                    >
                      Kembali
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% include "footer.html" %}
    <script src="{% static 'plugins.js' %}"></script>
    <script>
      $(window).on("load", function () {
        $("body").addClass("loaded");
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script src="{% static 'script.js' %}"></script>
    <script>

      window.addEventListener("load", function () {
          const kiri = document.querySelector(".motif-container");
          const kanan = document.querySelector(".combined-motif-container");
          const maxHeight = Math.max(kiri.offsetHeight, kanan.offsetHeight);
          kiri.style.height = kanan.style.height = maxHeight + "px";
        });

      function redirectToList() {
        window.location.href = "{% url 'list1' %}";
      }
      let allMotifImages = [];
      let urutanAsalArray = [];
      let urutanGabunganArray = [];

      function updateMotifNumbers() {
        const labels = document.querySelectorAll(".motif-number");
        const totalMotifs = allMotifImages.length;

        for (let i = 0; i < totalMotifs; i++) {
          labels[i].textContent = totalMotifs - i;
        }

        for (let i = totalMotifs; i < labels.length; i++) {
          labels[i].textContent = i - totalMotifs + 1;
        }
      }

      function renderMotifs() {
        const combinedMotifContainer = document.getElementById(
          "combinedMotifContainer"
        );
        combinedMotifContainer.innerHTML = "";

        if (allMotifImages.length === 0) {
          const notif = document.createElement("p");
          notif.className = "text-muted";
          notif.textContent = "Belum ada motif yang dipilih.";
          combinedMotifContainer.appendChild(notif);
          return;
        }

        const motifPair = document.createElement("div");
        motifPair.className = "motif-pair";
        motifPair.style.display = "flex";
        motifPair.style.flexDirection = "column";
        motifPair.style.alignItems = "center";

        function createMotifImage(src, index, isMirror = false) {
          const wrapper = document.createElement("div");
          wrapper.style.marginBottom = "20px";
          wrapper.style.textAlign = "center";
          wrapper.style.position = "relative";

          const label = document.createElement("span");
          label.className = "motif-number";
          label.textContent = index + 1;
          label.style.position = "absolute";
          label.style.top = "5px";
          label.style.left = "5px";
          label.style.backgroundColor = "blue";
          label.style.color = "white";
          label.style.padding = "2px 6px";
          label.style.fontWeight = "bold";
          label.style.fontSize = "12px";
          label.style.zIndex = "1";

          const img = document.createElement("img");
          img.src =
            src === "motif kosong"
              ? "https://via.placeholder.com/150?text=Kosong"
              : src;
          img.className = "motif-size";
          img.style.maxWidth = "500px";
          if (isMirror) img.style.transform = "scaleY(-1)";
          img.dataset.index = index;

          img.setAttribute(
            "data-urutanasal",
            JSON.stringify(urutanAsalArray[index] || [])
          );
          img.setAttribute("data-mirror", isMirror ? "true" : "false");

          img.onclick = function () {
            removeMotif(index);
          };

          wrapper.appendChild(img);
          wrapper.appendChild(label);
          return wrapper;
        }

        for (let i = allMotifImages.length - 1; i >= 0; i--) {
          motifPair.appendChild(
            createMotifImage(allMotifImages[i], i, false)
          );
        }

        const spacer = document.createElement("div");
        spacer.style.height = "20px";
        motifPair.appendChild(spacer);

        for (let i = 0; i < allMotifImages.length; i++) {
          motifPair.appendChild(createMotifImage(allMotifImages[i], i, true));
        }

        combinedMotifContainer.appendChild(motifPair);
        updateMotifNumbers();
        tampilkanUrutanGabungan();
      }

      function addMotif(imageElement) {
        const urutanArray = JSON.parse(
          imageElement.getAttribute("data-urutanasal")
        );
        const src = imageElement.src;
        const jumlahAktif = allMotifImages.filter(
          (item) => item !== "motif kosong"
        ).length;
        if (jumlahAktif >= 11) {
          alert("Motif yang ditambahkan maksimal 11!");
          return;
        }
        const kosongIndex = allMotifImages.findIndex(
          (item) => item === "motif kosong"
        );
        if (kosongIndex !== -1) {
          allMotifImages[kosongIndex] = src;
          urutanAsalArray[kosongIndex] = urutanArray;
        } else {
          allMotifImages.push(src);
          urutanAsalArray.push(urutanArray);
        }

        tampilkanUrutanGabungan();
        renderMotifs();
      }
      function removeMotif(indexToRemove) {
        if (
          indexToRemove >= 0 &&
          indexToRemove < allMotifImages.length &&
          indexToRemove < urutanAsalArray.length
        ) {
          if (allMotifImages[indexToRemove] === "motif kosong") {
            allMotifImages.splice(indexToRemove, 1);
            urutanAsalArray.splice(indexToRemove, 1);
          } else {
            allMotifImages[indexToRemove] = "motif kosong";
            urutanAsalArray[indexToRemove] = [];
          }

          renderMotifs();
          tampilkanUrutanGabungan();
        }
      }
      function tampilkanUrutanGabungan() {
        const normal = urutanAsalArray.flat();
        const mirror = urutanAsalArray
          .slice()
          .reverse()
          .map((arr) => [...arr].reverse())
          .flat();

        const gabungan = normal.concat(mirror);
        urutanGabunganArray = gabungan;
        console.log("Gabungan urutan:", gabungan);

        const el = document.getElementById("urutanGabungan");
        if (el) el.textContent = `Gabungan urutan: [${gabungan.join(", ")}]`;
      }

      function saveMotif() {
        const combinedMotifContainer = document.getElementById(
          "combinedMotifContainer"
        );

        if (
          combinedMotifContainer.children.length === 0 ||
          combinedMotifContainer.innerHTML.includes(
            "Belum ada motif yang dipilih"
          )
        ) {
          alert("Pilih motif terlebih dahulu!");
          return;
        }

        function loadImage(src) {
          return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = src;
          });
        }

        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === name + "=") {
                cookieValue = decodeURIComponent(
                  cookie.substring(name.length + 1)
                );
                break;
              }
            }
          }
          return cookieValue;
        }

        async function combineMotifs() {
          try {
            const motifImages = Array.from(
              combinedMotifContainer.querySelectorAll("img")
            );

            if (motifImages.length === 0) {
              alert("Tidak ada gambar ditemukan.");
              return;
            }

            const canvasWidth = 800;
            let totalHeight = 0;
            const loadedImages = [];

            for (let img of motifImages) {
              const loaded = await loadImage(img.src);
              const scale = canvasWidth / loaded.width;
              const scaledHeight = loaded.height * scale;
              loadedImages.push({ image: loaded, height: scaledHeight });
              totalHeight += scaledHeight;
            }

            const canvas = document.createElement("canvas");
            canvas.width = canvasWidth;
            canvas.height = totalHeight;
            const ctx = canvas.getContext("2d");
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvasWidth, totalHeight);
            let yOffset = 0;
            for (let { image, height } of loadedImages) {
              const scale = canvasWidth / image.width;
              ctx.drawImage(image, 0, yOffset, canvasWidth, height);
              yOffset += height;
            }
            const jumlahAsal = "{{ jumlahasal }}";

            const dataURL = canvas.toDataURL("image/png");
            const blob = await (await fetch(dataURL)).blob();
            const imgAsal = document.querySelector('img[data-jenis="asal"]');
            const imgBeforeSrc = imgAsal ? imgAsal.src : "";
            const formDataUpload = new FormData();
            formDataUpload.append("file", blob, "motif_gabung.png");
            formDataUpload.append("imgBefore", imgBeforeSrc);
            formDataUpload.append("imgAfter", "/media/uploads/itha.png");
            formDataUpload.append(
              "urutanLidi",
              urutanGabunganArray.join(",")
            );
            formDataUpload.append("jenisGenerate", "otomatis");
            formDataUpload.append("user", "itha");
            formDataUpload.append(
              "csrfmiddlewaretoken",
              getCookie("csrftoken")
            );
            formDataUpload.append("jmlBaris", urutanGabunganArray.join(","));
            const response = await fetch("/generator/PostImageGabungan", {
              method: "POST",
              body: formDataUpload,
              headers: {
                "X-CSRFToken": getCookie("csrftoken"),
              },
            });

            if (response.ok) {
              const successModal = new bootstrap.Modal(
                document.getElementById("successModal")
              );
              successModal.show();
            } else {
              const errorText = await response.text();
              throw new Error("Gagal menyimpan motif: " + errorText);
            }
          } catch (error) {
            console.error("Error:", error);
            alert("Gagal menyimpan motif: " + error.message);
          }
        }

        combineMotifs();
      }
    </script>
  </body>
</html>